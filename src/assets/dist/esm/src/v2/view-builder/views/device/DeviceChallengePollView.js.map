{"version":3,"file":"DeviceChallengePollView.js","sources":["../../../../../../../src/v2/view-builder/views/device/DeviceChallengePollView.js"],"sourcesContent":["import { loc, createCallout } from 'okta';\nimport { BaseFooter, BaseView, BaseOktaVerifyChallengeView } from '../../internals';\nimport Enums from '../../../../util/Enums';\nimport {\n  CANCEL_POLLING_ACTION,\n  IDENTIFIER_FLOW,\n  AUTHENTICATION_CANCEL_REASONS,\n} from '../../utils/Constants';\nimport Link from '../../components/Link';\nimport { doChallenge, cancelPollingWithParams } from '../../utils/ChallengeViewUtil';\nimport OktaVerifyAuthenticatorHeader from '../../components/OktaVerifyAuthenticatorHeader';\nimport { getSignOutLink } from '../../utils/LinksUtil';\n\nconst Body = BaseOktaVerifyChallengeView.extend({\n  pollingCancelAction: CANCEL_POLLING_ACTION,\n\n  getDeviceChallengePayload() {\n    return this.options.currentViewState.relatesTo.value;\n  },\n\n  doChallenge() {\n    doChallenge(this, IDENTIFIER_FLOW);\n  },\n\n  onPollingFail() {\n    BaseOktaVerifyChallengeView.prototype.onPollingFail.apply(this, arguments);\n    // When SIW receives form error, polling is already stopped\n    // SIW needs to update footer link from /poll/cancel to /idp/idx/cancel\n    const data = { label: loc('loopback.polling.cancel.link.with.form.error', 'login') };\n    this.options.appState.trigger('updateFooterLink', data);\n  },\n\n  showCustomFormErrorCallout(error) {\n    const responseJSON = error.responseJSON;\n    const options = {\n      type: 'error',\n      className: 'okta-verify-uv-callout-content',\n      subtitle: responseJSON.errorSummary,\n    };\n\n    const containsSignedNonceError = responseJSON.errorSummaryKeys &&\n      responseJSON.errorSummaryKeys.some((key) => key.includes('auth.factor.signedNonce.error'));\n    if (containsSignedNonceError) {\n      options.title = loc('user.fail.verifyIdentity', 'login');\n    }\n\n    this.showMessages(createCallout(options));\n    return true;\n  },\n});\n\nconst Footer = BaseFooter.extend({\n  initialize() {\n    this.listenTo(this.options.appState, 'updateFooterLink', this.handleUpdateFooterLink);\n    if (this.isFallbackApproach() && !this.isFallbackDelayed()) {\n      BaseFooter.prototype.initialize.apply(this, arguments);\n    } else {\n      this.backLink = this.add(Link, {\n        options: {\n          name: 'cancel-authenticator-challenge',\n          label: loc('loopback.polling.cancel.link', 'login'),\n          clickHandler: () => {\n            cancelPollingWithParams(\n              this.options.appState,\n              CANCEL_POLLING_ACTION,\n              AUTHENTICATION_CANCEL_REASONS.USER_CANCELED,\n              null\n            );\n          },\n        }\n      }).last();\n    }\n  },\n\n  handleUpdateFooterLink(data) {\n    // only update link for loopback\n    if (!this.isFallbackApproach() || this.isFallbackDelayed()) {\n      this.backLink && this.backLink.remove();\n      this.backLink = this.add(Link, {\n        options: getSignOutLink(this.options.settings, data)[0]\n      }).last();\n    } \n  },\n\n  isFallbackApproach() {\n    return [\n      Enums.CUSTOM_URI_CHALLENGE,\n      Enums.UNIVERSAL_LINK_CHALLENGE,\n      Enums.APP_LINK_CHALLENGE\n    ].includes(this.options.currentViewState.relatesTo.value.challengeMethod);\n  },\n\n  isFallbackDelayed() {\n    // only delay showing the reopen Okta Verify button for the app link approach for now\n    // until we have more data shows other approaches have the slow cold start problem of the Okta Verify app as well\n    return this.options.currentViewState.relatesTo.value.challengeMethod === Enums.APP_LINK_CHALLENGE;\n  },\n});\n\nexport default BaseView.extend({\n  Header: OktaVerifyAuthenticatorHeader,\n  Body,\n  Footer\n});\n"],"names":["Body","BaseOktaVerifyChallengeView","extend","pollingCancelAction","CANCEL_POLLING_ACTION","getDeviceChallengePayload","options","currentViewState","relatesTo","value","doChallenge","IDENTIFIER_FLOW","onPollingFail","prototype","apply","arguments","data","label","loc","appState","trigger","showCustomFormErrorCallout","error","responseJSON","type","className","subtitle","errorSummary","containsSignedNonceError","errorSummaryKeys","some","key","includes","title","showMessages","createCallout","Footer","BaseFooter","initialize","listenTo","handleUpdateFooterLink","isFallbackApproach","isFallbackDelayed","backLink","add","Link","name","clickHandler","cancelPollingWithParams","AUTHENTICATION_CANCEL_REASONS","USER_CANCELED","last","remove","getSignOutLink","settings","Enums","CUSTOM_URI_CHALLENGE","UNIVERSAL_LINK_CHALLENGE","APP_LINK_CHALLENGE","challengeMethod","BaseView","Header","OktaVerifyAuthenticatorHeader"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAaA,MAAMA,IAAI,GAAGC,MAA2B,CAACC,MAA5B,CAAmC;AAC9CC,EAAAA,mBAAmB,EAAEC,qBADyB;AAG9CC,EAAAA,yBAH8C,EAGlB,YAAA;AAC1B,IAAA,OAAO,KAAKC,OAAL,CAAaC,gBAAb,CAA8BC,SAA9B,CAAwCC,KAA/C,CAAA;AACD,GAL6C;AAO9CC,EAAAA,WAP8C,EAOhC,YAAA;AACZA,IAAAA,WAAW,CAAC,IAAD,EAAOC,eAAP,CAAX,CAAA;AACD,GAT6C;AAW9CC,EAAAA,aAX8C,EAW9B,YAAA;AACdX,IAAAA,MAA2B,CAACY,SAA5B,CAAsCD,aAAtC,CAAoDE,KAApD,CAA0D,IAA1D,EAAgEC,SAAhE,CAAA,CADc;AAGd;;AACA,IAAA,MAAMC,IAAI,GAAG;AAAEC,MAAAA,KAAK,EAAEC,GAAG,CAAC,8CAAD,EAAiD,OAAjD,CAAA;AAAZ,KAAb,CAAA;AACA,IAAKZ,IAAAA,CAAAA,OAAL,CAAaa,QAAb,CAAsBC,OAAtB,CAA8B,kBAA9B,EAAkDJ,IAAlD,CAAA,CAAA;AACD,GAjB6C;AAmB9CK,EAAAA,0BAnB8C,EAmBnBC,UAAAA,KAnBmB,EAmBZ;AAChC,IAAA,MAAMC,YAAY,GAAGD,KAAK,CAACC,YAA3B,CAAA;AACA,IAAA,MAAMjB,OAAO,GAAG;AACdkB,MAAAA,IAAI,EAAE,OADQ;AAEdC,MAAAA,SAAS,EAAE,gCAFG;AAGdC,MAAAA,QAAQ,EAAEH,YAAY,CAACI,YAAAA;AAHT,KAAhB,CAAA;AAMA,IAAMC,MAAAA,wBAAwB,GAAGL,YAAY,CAACM,gBAAb,IAC/BN,YAAY,CAACM,gBAAb,CAA8BC,IAA9B,CAAoCC,GAAD,IAASA,GAAG,CAACC,QAAJ,CAAa,+BAAb,CAA5C,CADF,CAAA;;AAEA,IAAA,IAAIJ,wBAAJ,EAA8B;AAC5BtB,MAAAA,OAAO,CAAC2B,KAAR,GAAgBf,GAAG,CAAC,0BAAD,EAA6B,OAA7B,CAAnB,CAAA;AACD,KAAA;;AAED,IAAA,IAAA,CAAKgB,YAAL,CAAkBC,aAAa,CAAC7B,OAAD,CAA/B,CAAA,CAAA;AACA,IAAA,OAAO,IAAP,CAAA;AACD,GAAA;AAnC6C,CAAnC,CAAb,CAAA;AAsCA,MAAM8B,MAAM,GAAGC,UAAU,CAACnC,MAAX,CAAkB;AAC/BoC,EAAAA,UAD+B,EAClB,YAAA;AACX,IAAKC,IAAAA,CAAAA,QAAL,CAAc,IAAA,CAAKjC,OAAL,CAAaa,QAA3B,EAAqC,kBAArC,EAAyD,IAAA,CAAKqB,sBAA9D,CAAA,CAAA;;AACA,IAAA,IAAI,KAAKC,kBAAL,EAAA,IAA6B,CAAC,IAAKC,CAAAA,iBAAL,EAAlC,EAA4D;AAC1DL,MAAAA,UAAU,CAACxB,SAAX,CAAqByB,UAArB,CAAgCxB,KAAhC,CAAsC,IAAtC,EAA4CC,SAA5C,CAAA,CAAA;AACD,KAFD,MAEO;AACL,MAAA,IAAA,CAAK4B,QAAL,GAAgB,IAAA,CAAKC,GAAL,CAASC,IAAT,EAAe;AAC7BvC,QAAAA,OAAO,EAAE;AACPwC,UAAAA,IAAI,EAAE,gCADC;AAEP7B,UAAAA,KAAK,EAAEC,GAAG,CAAC,8BAAD,EAAiC,OAAjC,CAFH;AAGP6B,UAAAA,YAAY,EAAE,MAAM;AAClBC,YAAAA,uBAAuB,CACrB,IAAK1C,CAAAA,OAAL,CAAaa,QADQ,EAErBf,qBAFqB,EAGrB6C,6BAA6B,CAACC,aAHT,EAIrB,IAJqB,CAAvB,CAAA;AAMD,WAAA;AAVM,SAAA;AADoB,OAAf,CAAA,CAabC,IAba,EAAhB,CAAA;AAcD,KAAA;AACF,GArB8B;AAuB/BX,EAAAA,sBAvB+B,EAuBRxB,UAAAA,IAvBQ,EAuBF;AAC3B;AACA,IAAI,IAAA,CAAC,KAAKyB,kBAAL,EAAD,IAA8B,IAAKC,CAAAA,iBAAL,EAAlC,EAA4D;AAC1D,MAAA,IAAA,CAAKC,QAAL,IAAiB,IAAA,CAAKA,QAAL,CAAcS,MAAd,EAAjB,CAAA;AACA,MAAA,IAAA,CAAKT,QAAL,GAAgB,IAAA,CAAKC,GAAL,CAASC,IAAT,EAAe;AAC7BvC,QAAAA,OAAO,EAAE+C,cAAc,CAAC,IAAK/C,CAAAA,OAAL,CAAagD,QAAd,EAAwBtC,IAAxB,CAAd,CAA4C,CAA5C,CAAA;AADoB,OAAf,CAAA,CAEbmC,IAFa,EAAhB,CAAA;AAGD,KAAA;AACF,GA/B8B;AAiC/BV,EAAAA,kBAjC+B,EAiCV,YAAA;AACnB,IAAO,OAAA,CACLc,KAAK,CAACC,oBADD,EAELD,KAAK,CAACE,wBAFD,EAGLF,KAAK,CAACG,kBAHD,EAIL1B,QAJK,CAII,IAAK1B,CAAAA,OAAL,CAAaC,gBAAb,CAA8BC,SAA9B,CAAwCC,KAAxC,CAA8CkD,eAJlD,CAAP,CAAA;AAKD,GAvC8B;AAyC/BjB,EAAAA,iBAzC+B,EAyCX,YAAA;AAClB;AACA;AACA,IAAA,OAAO,IAAKpC,CAAAA,OAAL,CAAaC,gBAAb,CAA8BC,SAA9B,CAAwCC,KAAxC,CAA8CkD,eAA9C,KAAkEJ,KAAK,CAACG,kBAA/E,CAAA;AACD,GAAA;AA7C8B,CAAlB,CAAf,CAAA;AAgDA,8BAAeE,QAAQ,CAAC1D,MAAT,CAAgB;AAC7B2D,EAAAA,MAAM,EAAEC,6BADqB;AAE7B9D,EAAAA,IAAI,EAAJA,IAF6B;AAG7BoC,EAAAA,MAAM,EAANA,MAAAA;AAH6B,CAAhB,CAAf;;;;"}
{"version":3,"file":"ChallengeWebauthnView.js","sources":["../../../../../../../src/v2/view-builder/views/webauthn/ChallengeWebauthnView.js"],"sourcesContent":["import { _, loc, createButton, createCallout } from 'okta';\nimport { BaseForm } from '../../internals';\nimport BaseAuthenticatorView from '../../components/BaseAuthenticatorView';\nimport CryptoUtil from '../../../../util/CryptoUtil';\nimport webauthn from '../../../../util/webauthn';\nimport BrowserFeatures from '../../../../util/BrowserFeatures';\nimport ChallengeWebauthnInfoView from './ChallengeWebauthnInfoView';\nimport { getMessageFromBrowserError } from '../../../ion/i18nTransformer';\nimport ChallengeWebauthnFooter from '../../components/ChallengeWebauthnFooter';\nimport { FORMS as RemediationForms } from '../../../ion/RemediationConstants';\nimport EnrollWebAuthnResidentKeyLinkView from './EnrollWebAuthnResidentkeyLinkView';\n\nconst Body = BaseForm.extend({\n\n  title() {\n    return loc('oie.verify.webauth.title', 'login');\n  },\n\n  className: 'oie-verify-webauthn',\n\n  getUISchema() {\n    const schema = [];\n    // Returning custom array so no input fields are displayed for webauthn\n    if (webauthn.isNewApiAvailable()) {\n      const retryButton = createButton({\n        className: 'retry-webauthn button-primary default-custom-button',\n        title: loc('mfa.challenge.verify', 'login'),\n        click: () => {\n          this.getCredentialsAndSave();\n        }\n      });\n\n      schema.push({\n        View: ChallengeWebauthnInfoView,\n      }, {\n        View: retryButton,\n      });\n      if (this._canSetupWebAuthnResidentKey()) {\n        schema.push({View: EnrollWebAuthnResidentKeyLinkView});\n      }\n    } else {\n      schema.push({\n        View: createCallout({\n          className: 'webauthn-not-supported',\n          type: 'error',\n          subtitle: loc('oie.webauthn.error.not.supported', 'login'),\n        }),\n      });\n    }\n    return schema;\n  },\n\n  remove() {\n    BaseForm.prototype.remove.apply(this, arguments);\n    if (this.webauthnAbortController) {\n      this.webauthnAbortController.abort();\n      this.webauthnAbortController = null;\n    }\n  },\n\n  noButtonBar: true,\n\n  modelEvents: {\n    'error': '_stopVerification'\n  },\n\n  getCredentialsAndSave() {\n    this.clearErrors();\n    this._startVerification();\n    // AbortController is not supported in IE11\n    if (typeof AbortController !== 'undefined') {\n      this.webauthnAbortController = new AbortController();\n    }\n    const relatesToObject = this.options.currentViewState.relatesTo;\n    const authenticatorData = relatesToObject?.value || {};\n    const allowCredentials = [];\n    const authenticatorEnrollments = this.options.appState.get('authenticatorEnrollments')?.value || [];\n    authenticatorEnrollments.forEach((enrollement) => {\n      if (enrollement.key === 'webauthn') {\n        allowCredentials.push({\n          type: 'public-key',\n          id: CryptoUtil.strToBin(enrollement.credentialId),\n        });\n      }\n    });\n    const challengeData = authenticatorData.contextualData.challengeData;\n    const options = _.extend({}, challengeData, {\n      allowCredentials,\n      challenge: CryptoUtil.strToBin(challengeData.challenge),\n    });\n    // navigator.credentials() is not supported in IE11\n    // eslint-disable-next-line compat/compat\n    navigator.credentials.get({\n      publicKey: options,\n      signal: this.webauthnAbortController && this.webauthnAbortController.signal\n    }).then((assertion) => {\n      const credentials = {\n        clientData: CryptoUtil.binToStr(assertion.response.clientDataJSON),\n        authenticatorData: CryptoUtil.binToStr(assertion.response.authenticatorData),\n        signatureData: CryptoUtil.binToStr(assertion.response.signature)\n      };\n      const hasUserHandleSchema = this.options.appState.getSchemaByName('credentials.userHandle');\n      if (hasUserHandleSchema) {\n        _.extend(credentials, {\n          userHandle: CryptoUtil.binToStr(assertion.response.userHandle ?? '')\n        });\n      }\n      \n      this.model.set({\n        credentials\n      });\n      this.saveForm(this.model);\n    }, (error) => {\n      // Do not display if it is abort error triggered by code when switching.\n      // this.webauthnAbortController would be null if abort was triggered by code.\n      if (this.webauthnAbortController) {\n        this.model.trigger('error', this.model, {responseJSON: {errorSummary: getMessageFromBrowserError(error)}});\n      }\n    }).finally(() => {\n      // unset webauthnAbortController on successful authentication or error\n      this.webauthnAbortController = null;\n    });\n  },\n\n  _startVerification: function() {\n    this.$('.okta-waiting-spinner').show();\n    this.$('.retry-webauthn').hide();\n    this.$('.setup-webauthn-residentkey-text').hide();\n    this.$('.retry-webauthn')[0].textContent = loc('retry', 'login');\n  },\n\n  _stopVerification: function() {\n    this.$('.okta-waiting-spinner').hide();\n    this.$('.retry-webauthn').show();\n    this.$('.setup-webauthn-residentkey-text').show();\n  },\n\n  _canSetupWebAuthnResidentKey: function() {\n    return this.options.appState.hasRemediationObject(RemediationForms.ENROLL_WEBAUTHN_RESIDENTKEY);\n  }\n});\n\nexport default BaseAuthenticatorView.extend({\n  Body,\n  Footer: ChallengeWebauthnFooter,\n  postRender() {\n    BaseAuthenticatorView.prototype.postRender.apply(this, arguments);\n    // Trigger browser prompt automatically for other browsers for better UX.\n    if (webauthn.isNewApiAvailable() && !BrowserFeatures.isSafari()) {\n      this.form.getCredentialsAndSave();\n    }\n  },\n});\n"],"names":["Body","BaseForm","extend","title","loc","className","getUISchema","schema","webauthn","isNewApiAvailable","retryButton","createButton","click","getCredentialsAndSave","push","View","ChallengeWebauthnInfoView","_canSetupWebAuthnResidentKey","EnrollWebAuthnResidentKeyLinkView","createCallout","type","subtitle","remove","prototype","apply","arguments","webauthnAbortController","abort","noButtonBar","modelEvents","clearErrors","_startVerification","AbortController","relatesToObject","options","currentViewState","relatesTo","authenticatorData","value","allowCredentials","authenticatorEnrollments","appState","get","forEach","enrollement","key","id","CryptoUtil","strToBin","credentialId","challengeData","contextualData","_","challenge","navigator","credentials","publicKey","signal","then","assertion","clientData","binToStr","response","clientDataJSON","signatureData","signature","hasUserHandleSchema","getSchemaByName","userHandle","model","set","saveForm","error","trigger","responseJSON","errorSummary","getMessageFromBrowserError","finally","$","show","hide","textContent","_stopVerification","hasRemediationObject","RemediationForms","ENROLL_WEBAUTHN_RESIDENTKEY","BaseAuthenticatorView","Footer","ChallengeWebauthnFooter","postRender","BrowserFeatures","isSafari","form"],"mappings":"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"}
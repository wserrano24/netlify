{"version":3,"file":"EnrollWebauthnView.js","sources":["../../../../../../../src/v2/view-builder/views/webauthn/EnrollWebauthnView.js"],"sourcesContent":["import { _, loc, createCallout, createButton } from 'okta';\nimport { BaseForm } from '../../internals';\nimport BaseAuthenticatorView from '../../components/BaseAuthenticatorView';\nimport webauthn from 'util/webauthn';\nimport CryptoUtil from 'util/CryptoUtil';\nimport EnrollWebauthnInfoView from './EnrollWebauthnInfoView';\nimport { getMessageFromBrowserError } from '../../../ion/i18nTransformer';\n\nfunction getExcludeCredentials(authenticatorEnrollments = []) {\n  const credentials = [];\n  authenticatorEnrollments.forEach((enrollement) => {\n    if (enrollement.key === 'webauthn') {\n      credentials.push({\n        type: 'public-key',\n        id: CryptoUtil.strToBin(enrollement.credentialId),\n      });\n    }\n  });\n  return credentials;\n}\n\nconst Body = BaseForm.extend({\n  title() {\n    return loc('oie.enroll.webauthn.title', 'login');\n  },\n  className: 'oie-enroll-webauthn',\n  modelEvents: {\n    'error': '_stopEnrollment',\n  },\n  getUISchema() {\n    const schema = [];\n    // Returning custom array so no input fields are displayed for webauthn\n    if (webauthn.isNewApiAvailable()) {\n      schema.push({\n        View: EnrollWebauthnInfoView,\n      });\n      schema.push({\n        View: createButton({\n          className: 'webauthn-setup button button-primary button-wide',\n          title: loc('oie.enroll.webauthn.save', 'login'),\n          click: () => {\n            this.triggerWebauthnPrompt();\n          },\n        }),\n      });\n    } else {\n      schema.push({\n        View: createCallout({\n          className: 'webauthn-not-supported',\n          type: 'error',\n          subtitle: loc('oie.webauthn.error.not.supported', 'login'),\n        }),\n      });\n    }\n    return schema;\n  },\n  triggerWebauthnPrompt() {\n    this.$el.find('.o-form-error-container').empty();\n    this._startEnrollment();\n    const relatesToObject = this.options.currentViewState.relatesTo;\n    const activationData = relatesToObject?.value.contextualData.activationData;\n    if (webauthn.isNewApiAvailable()) {\n      const excludeCredentials = activationData.authenticatorSelection?.requireResidentKey === true ?\n        [] :\n        getExcludeCredentials(this.options.appState.get('authenticatorEnrollments').value);\n      const options = _.extend({}, activationData, {\n        challenge: CryptoUtil.strToBin(activationData.challenge),\n        user: {\n          id: CryptoUtil.strToBin(activationData.user.id),\n          name: activationData.user.name,\n          displayName: activationData.user.displayName\n        },\n        excludeCredentials\n      });\n      // AbortController is not supported in IE11\n      if (typeof AbortController !== 'undefined') {\n        this.webauthnAbortController = new AbortController();\n      }\n      navigator.credentials.create({\n        publicKey: options,\n        signal: this.webauthnAbortController && this.webauthnAbortController.signal\n      }).then((newCredential) => {\n        this.model.set({\n          credentials : {\n            clientData: CryptoUtil.binToStr(newCredential.response.clientDataJSON),\n            attestation: CryptoUtil.binToStr(newCredential.response.attestationObject),\n          }\n        });\n        this.saveForm(this.model);\n      })\n        .catch((error) => {\n          this.model.trigger('error', this.model, {responseJSON: {errorSummary: getMessageFromBrowserError(error)}});\n        }).finally(() => {\n          this.webauthnAbortController = null;\n        });\n    }\n  },\n  _startEnrollment: function() {\n    this.$('.okta-waiting-spinner').show();\n    this.$('.webauthn-setup').hide();\n  },\n\n  _stopEnrollment: function() {\n    this.$('.okta-waiting-spinner').hide();\n    this.$('.webauthn-setup').show();\n  },\n});\n\nexport default BaseAuthenticatorView.extend({\n  Body,\n  postRender() {\n    BaseAuthenticatorView.prototype.postRender.apply(this, arguments);\n    this.$el.find('.o-form-button-bar [type=\"submit\"]').remove();\n  },\n});\n"],"names":["getExcludeCredentials","authenticatorEnrollments","credentials","forEach","enrollement","key","push","type","id","CryptoUtil","strToBin","credentialId","Body","BaseForm","extend","title","loc","className","modelEvents","getUISchema","schema","webauthn","isNewApiAvailable","View","EnrollWebauthnInfoView","createButton","click","triggerWebauthnPrompt","createCallout","subtitle","$el","find","empty","_startEnrollment","relatesToObject","options","currentViewState","relatesTo","activationData","value","contextualData","excludeCredentials","authenticatorSelection","requireResidentKey","appState","get","_","challenge","user","name","displayName","AbortController","webauthnAbortController","navigator","create","publicKey","signal","then","newCredential","model","set","clientData","binToStr","response","clientDataJSON","attestation","attestationObject","saveForm","catch","error","trigger","responseJSON","errorSummary","getMessageFromBrowserError","finally","$","show","hide","_stopEnrollment","BaseAuthenticatorView","postRender","prototype","apply","arguments","remove"],"mappings":"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"}
{"version":3,"file":"BaseAuthenticatorEmailView.js","sources":["../../../../../../../src/v2/view-builder/views/email/BaseAuthenticatorEmailView.js"],"sourcesContent":["import { loc, createCallout } from 'okta';\nimport { BaseForm } from '../../internals';\nimport email from '../shared/email';\nimport BaseAuthenticatorView from '../../components/BaseAuthenticatorView';\nimport BaseResendView from '../shared/BaseResendView';\nimport BaseFormWithPolling from '../../internals/BaseFormWithPolling';\n\nconst ResendView = BaseResendView.extend(\n  {\n    className: 'hide resend-email-view',\n    events: {\n      'click a.resend-link' : 'handelResendLink'\n    },\n\n    initialize() {\n      this.add(createCallout({\n        content: `${loc('email.code.not.received', 'login')}\n        <a class='resend-link'>${loc('email.button.resend', 'login')}</a>`,\n        type: 'warning',\n      }));\n    },\n\n    handelResendLink() {\n      this.options.appState.trigger('invokeAction', this.options.resendEmailAction);\n      // Hide warning, but reinitiate to show warning again after some threshold of polling\n      if (!this.$el.hasClass('hide')) {\n        this.$el.addClass('hide');\n      }\n      this.showCalloutAfterTimeout();\n    },\n  },\n);\n\nconst Body = BaseFormWithPolling.extend(Object.assign(\n  {\n    save() {\n      return loc('mfa.challenge.verify', 'login');\n    },\n    initialize() {\n      BaseFormWithPolling.prototype.initialize.apply(this, arguments);\n\n      this.add(ResendView, {\n        selector: '.o-form-error-container',\n        options: {\n          resendEmailAction: this.resendEmailAction,\n        }\n      });\n      this.startPolling();\n    },\n\n    saveForm() {\n      BaseForm.prototype.saveForm.apply(this, arguments);\n      this.stopPolling();\n    },\n\n    remove() {\n      BaseForm.prototype.remove.apply(this, arguments);\n      this.stopPolling();\n    },\n\n    triggerAfterError(model, error) {\n      BaseForm.prototype.triggerAfterError.apply(this, arguments);\n      const isFormPolling = !!this.polling;\n      this.stopPolling();\n\n      if (error.responseJSON?.errorSummaryKeys?.includes('idx.session.expired')) {\n        // Do NOT resume polling since session is invalid and polling is already stopped\n        return;\n      }\n\n      if (this.isRateLimitError(error)) {\n        // When polling encounter rate limit error, wait 60 sec for rate limit bucket to reset\n        // before polling again & hide error message\n        if (isFormPolling) {\n          setTimeout(() => {\n            model.trigger('clearFormError');\n          }, 0);\n        }\n        this.startPolling(60000);\n      } else {\n        this.startPolling(this.options.appState.get('dynamicRefreshInterval'));\n      }\n    },\n\n    isRateLimitError(error) {\n      return (error.responseJSON?.errorSummaryKeys?.includes('tooManyRequests') // IDX API error\n        || (error.responseJSON?.errorCode === 'E0000047') && !error.responseJSON?.errorIntent); // Standard API error\n    },\n  },\n  email,\n));\n\nexport default BaseAuthenticatorView.extend({\n  Body,\n});\n"],"names":["ResendView","BaseResendView","extend","className","events","initialize","add","createCallout","content","loc","type","handelResendLink","options","appState","trigger","resendEmailAction","$el","hasClass","addClass","showCalloutAfterTimeout","Body","BaseFormWithPolling","Object","assign","save","prototype","apply","arguments","selector","startPolling","saveForm","BaseForm","stopPolling","remove","triggerAfterError","model","error","isFormPolling","polling","responseJSON","errorSummaryKeys","includes","isRateLimitError","setTimeout","get","errorCode","errorIntent","email","BaseAuthenticatorView"],"mappings":"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"}
{"version":3,"file":"BaseOktaVerifyChallengeView.js","sources":["../../../../../../src/v2/view-builder/internals/BaseOktaVerifyChallengeView.js"],"sourcesContent":["import { $ } from 'okta';\nimport { BaseFormWithPolling } from '../internals';\nimport Logger from 'util/Logger';\nimport {\n  AUTHENTICATOR_CANCEL_ACTION,\n  AUTHENTICATION_CANCEL_REASONS,\n  CHALLENGE_TIMEOUT,\n} from '../utils/Constants';\nimport BrowserFeatures from 'util/BrowserFeatures';\nimport { doChallenge, cancelPollingWithParams } from '../utils/ChallengeViewUtil';\n\nconst request = (opts) => {\n  const ajaxOptions = Object.assign({\n    method: 'GET',\n    contentType: 'application/json',\n  }, opts);\n  return $.ajax(ajaxOptions);\n};\n\nconst Body = BaseFormWithPolling.extend({\n  noButtonBar: true,\n\n  className: 'ion-form device-challenge-poll',\n\n  events: {\n    'click #launch-ov': function(e) {\n      e.preventDefault();\n      this.doCustomURI();\n    }\n  },\n\n  pollingCancelAction: AUTHENTICATOR_CANCEL_ACTION,\n\n  initialize() {\n    BaseFormWithPolling.prototype.initialize.apply(this, arguments);\n    this.listenTo(this.model, 'error', this.onPollingFail);\n    this.doChallenge();\n    this.startPolling();\n  },\n\n  doChallenge() {\n    doChallenge(this);\n  },\n\n  onPollingFail() {\n    this.$('.spinner').hide();\n    this.stopPolling();\n  },\n\n  remove() {\n    BaseFormWithPolling.prototype.remove.apply(this, arguments);\n    this.stopProbing();\n    this.stopPolling();\n  },\n\n  getDeviceChallengePayload() {\n    throw new Error('getDeviceChallengePayload needs to be implemented');\n  },\n\n  doLoopback(deviceChallenge) {\n    let authenticatorDomainUrl = deviceChallenge.domain !== undefined ? deviceChallenge.domain : '';\n    let ports = deviceChallenge.ports !== undefined ? deviceChallenge.ports : [];\n    let challengeRequest = deviceChallenge.challengeRequest !== undefined ? deviceChallenge.challengeRequest : '';\n    let probeTimeoutMillis = deviceChallenge.probeTimeoutMillis !== undefined ?\n      deviceChallenge.probeTimeoutMillis : 100;\n    let currentPort;\n    let foundPort = false;\n    let ovFailed = false;\n    let countFailedPorts = 0;\n\n    const getAuthenticatorUrl = (path) => {\n      return `${authenticatorDomainUrl}:${currentPort}/${path}`;\n    };\n\n    const checkPort = () => {\n      return request({\n        url: getAuthenticatorUrl('probe'),\n        /*\n        OKTA-278573 in loopback server, SSL handshake sometimes takes more than 100ms and thus needs additional\n        timeout however, increasing timeout is a temporary solution since user will need to wait much longer in\n        worst case.\n        TODO: Android timeout is temporarily set to 3000ms and needs optimization post-Beta.\n        OKTA-365427 introduces probeTimeoutMillis; but we should also consider probeTimeoutMillisHTTPS for\n        customizing timeouts in the more costly Android and other (keyless) HTTPS scenarios.\n        */\n        timeout: BrowserFeatures.isAndroid() ? 3000 : probeTimeoutMillis\n      });\n    };\n\n    const onPortFound = () => {\n      return request({\n        url: getAuthenticatorUrl('challenge'),\n        method: 'POST',\n        data: JSON.stringify({ challengeRequest }),\n        timeout: CHALLENGE_TIMEOUT // authenticator should respond within 5 min (300000ms) for challenge request\n      });\n    };\n\n    const onFailure = () => {\n      Logger.error(`Something unexpected happened while we were checking port ${currentPort}.`);\n    };\n\n    const doProbing = () => {\n      return checkPort()\n        .done(() => {\n          return onPortFound()\n            .done(() => {\n              foundPort = true;\n              // once the OV challenge succeeds,\n              // triggers another polling right away without waiting for the next ongoing polling to be triggered\n              // to make the authentication flow goes faster \n              return this.trigger('save', this.model);\n            })\n            .fail((xhr) => {\n              countFailedPorts++;\n              // Windows and MacOS return status code 503 when \n              // there are multiple profiles on the device and\n              // the wrong OS profile responds to the challenge request\n              if (xhr.status !== 503) {\n                // when challenge responds with other errors,\n                // - stop the remaining probing\n                ovFailed = true;\n                // - cancel polling right away\n                cancelPollingWithParams(\n                  this.options.appState,\n                  this.pollingCancelAction,\n                  AUTHENTICATION_CANCEL_REASONS.OV_ERROR,\n                  xhr.status\n                );\n              } else if (countFailedPorts === ports.length) {\n                // when challenge is responded by the wrong OS profile and\n                // all the ports are exhausted,\n                // cancel the polling like the probing has failed\n                cancelPollingWithParams(\n                  this.options.appState,\n                  this.pollingCancelAction,\n                  AUTHENTICATION_CANCEL_REASONS.LOOPBACK_FAILURE,\n                  null\n                );\n              }\n            });\n        })\n        .fail(onFailure);\n    };\n\n    let probeChain = Promise.resolve();\n    ports.forEach(port => {\n      probeChain = probeChain\n        .then(() => {\n          if (!(foundPort || ovFailed)) {\n            currentPort = port;\n            return doProbing();\n          }\n        })\n        .catch(() => {\n          countFailedPorts++;\n          Logger.error(`Authenticator is not listening on port ${currentPort}.`);\n          if (countFailedPorts === ports.length) {\n            Logger.error('No available ports. Loopback server failed and polling is cancelled.');\n            cancelPollingWithParams(\n              this.options.appState,\n              this.pollingCancelAction,\n              AUTHENTICATION_CANCEL_REASONS.LOOPBACK_FAILURE,\n              null\n            );\n          }\n        });\n    });\n  },\n\n  doCustomURI() {\n    this.ulDom && this.ulDom.remove();\n    this.ulDom = this.add(`\n      <iframe src=\"${this.customURI}\" id=\"custom-uri-container\" style=\"display:none;\"></iframe>\n    `).last();\n  },\n\n  stopProbing() {\n    this.checkPortXhr && this.checkPortXhr.abort();\n    this.probingXhr && this.probingXhr.abort();\n  },\n});\n\nexport default Body;\n"],"names":["request","opts","ajaxOptions","Object","assign","method","contentType","$","ajax","Body","BaseFormWithPolling","extend","noButtonBar","className","events","e","preventDefault","doCustomURI","pollingCancelAction","AUTHENTICATOR_CANCEL_ACTION","initialize","prototype","apply","arguments","listenTo","model","onPollingFail","doChallenge","startPolling","hide","stopPolling","remove","stopProbing","getDeviceChallengePayload","Error","doLoopback","deviceChallenge","authenticatorDomainUrl","domain","undefined","ports","challengeRequest","probeTimeoutMillis","currentPort","foundPort","ovFailed","countFailedPorts","getAuthenticatorUrl","path","checkPort","url","timeout","BrowserFeatures","isAndroid","onPortFound","data","JSON","stringify","CHALLENGE_TIMEOUT","onFailure","Logger","error","doProbing","done","trigger","fail","xhr","status","cancelPollingWithParams","options","appState","AUTHENTICATION_CANCEL_REASONS","OV_ERROR","length","LOOPBACK_FAILURE","probeChain","Promise","resolve","forEach","port","then","catch","ulDom","add","customURI","last","checkPortXhr","abort","probingXhr"],"mappings":"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"}
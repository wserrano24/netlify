{"version":3,"file":"formatError.js","sources":["../../../../../src/v2/client/formatError.ts"],"sourcesContent":["/*!\n * Copyright (c) 2021-Present, Okta, Inc. and/or its affiliates. All rights reserved.\n * The Okta software accompanied by this notice is provided pursuant to the Apache License, Version 2.0 (the \"License.\")\n *\n * You may obtain a copy of the License at http://www.apache.org/licenses/LICENSE-2.0.\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n *\n * See the License for the specific language governing permissions and limitations under the License.\n */\n\nimport {\n  IdxContext,\n  IdxMessages,\n  IdxResponse,\n  RawIdxResponse\n} from '@okta/okta-auth-js';\nimport { loc } from 'okta';\n\nexport interface LegacyIdxError {\n  error: string;\n  details: IdxResponse\n}\n\nexport interface StandardApiError {\n  error: string;\n  error_description: string;\n}\n\nexport function isInvalidRecoveryTokenError(error): error is StandardApiError {\n  // special case: error from interact when passing an (invalid) recovery token\n  return (error?.error === 'invalid_request' && error.error_description === 'The recovery token is invalid');\n}\n\nexport function formatInvalidRecoveryTokenError(error: StandardApiError) {\n  // This error comes from `oauth2/interact` so is not an IDX error.\n  // simulate an IDX-JS error response\n  const idxError = formatIDXError(error);\n  const { details } = idxError;\n  const messages: IdxMessages = {\n    type: 'array',\n    value: [\n      {\n        message: error.error_description,\n        i18n: {\n          key: 'oie.invalid.recovery.token'\n        },\n        class: 'ERROR'\n      }\n    ],\n  };\n  details.rawIdxState.messages = messages;\n  details.context.messages = messages;\n  return idxError;\n}\n\nexport function isOIENotEnabledError(error): error is StandardApiError {\n  // special case: error from interact. `useInteractionCodeFlow` is true but the Org does not have OIE enabled\n  // The response is not in IDX format. See playground/mocks/data/oauth2/error-feature-not-enabled.json\n  return (error?.error === 'access_denied' && error.error_description);\n}\n\nexport function formatOIENotEnabledError(error: StandardApiError) {\n  // This error comes from `oauth2/interact` so the error is in OAuth format\n  // simulate an IDX-JS error response\n  const idxError = formatIDXError(error);\n  const { details } = idxError;\n  const messages: IdxMessages = {\n    type: 'array',\n    value: [\n      {\n        message: error.error_description,\n        i18n: {\n          key: 'oie.feature.disabled'\n        },\n        class: 'ERROR'\n      }\n    ],\n  };\n  details.rawIdxState.messages = messages;\n  details.context.messages = messages;\n  return error;\n}\n\nexport function isOIEConfigurationError(error): error is StandardApiError {\n  return (error?.error && error.error_description);\n}\n\nexport function formatOIEConfigurationError(error) {\n  // This error comes from `oauth2/interact` so the error is in OAuth format\n  // simulate an IDX-JS error response\n  const idxError = formatIDXError(error);\n  const { details } = idxError;\n  const messages: IdxMessages = {\n    type: 'array',\n    value: [\n      {\n        message: loc('oie.configuration.error', 'login'),\n        class: 'ERROR',\n        i18n: undefined\n      }\n    ],\n  };\n  details.rawIdxState.messages = messages;\n  details.context.messages = messages;\n  return error;\n}\n\nexport function formatIDXError(error: LegacyIdxError | StandardApiError | Error): LegacyIdxError {\n  // Make the error object resemble an IDX response\n  const idxError = error as LegacyIdxError;\n  idxError.details = idxError.details || {} as IdxResponse;\n  const { details } = idxError;\n  details.rawIdxState = details.rawIdxState || {} as RawIdxResponse;\n  details.context = details.context || {} as IdxContext;\n  details.neededToProceed = details.neededToProceed || [];\n\n  // Populate generic error message if there isn't any.\n  if (!details.rawIdxState.messages) {\n    const idxMessage: IdxMessages = {\n      type: 'array',\n      value: [\n        {\n          message: loc('oform.error.unexpected', 'login'),\n          class: 'ERROR',\n          i18n: undefined\n        }\n      ]\n    };\n    details.rawIdxState.messages = idxMessage;\n    details.context.messages = idxMessage;\n  }\n\n  return idxError;\n}\n\nexport function formatError(error: string | Error | LegacyIdxError | StandardApiError) {\n  // If the error is a string, wrap it in an Error object\n  if (typeof error === 'string') {\n    error = new Error(error);\n  }\n\n  // special case error handling\n\n  // invalid reccovery token\n  if (isInvalidRecoveryTokenError(error)) {\n    return formatInvalidRecoveryTokenError(error);\n  }\n\n  // OIE is not enabled\n  if (isOIENotEnabledError(error)) {\n    return formatOIENotEnabledError(error);\n  }\n\n  // Other errors from /interact in OAuth format\n  if (isOIEConfigurationError(error)) {\n    return formatOIEConfigurationError(error);\n  }\n\n  error = formatIDXError(error);\n  return error;\n}"],"names":["isInvalidRecoveryTokenError","error","error_description","formatInvalidRecoveryTokenError","idxError","formatIDXError","details","messages","type","value","message","i18n","key","class","rawIdxState","context","isOIENotEnabledError","formatOIENotEnabledError","isOIEConfigurationError","formatOIEConfigurationError","loc","undefined","neededToProceed","idxMessage","formatError","Error"],"mappings":"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"}
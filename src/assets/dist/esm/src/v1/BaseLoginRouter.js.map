{"version":3,"file":"BaseLoginRouter.js","sources":["../../../../src/v1/BaseLoginRouter.js"],"sourcesContent":["/*!\n * Copyright (c) 2015-2016, Okta, Inc. and/or its affiliates. All rights reserved.\n * The Okta software accompanied by this notice is provided pursuant to the Apache License, Version 2.0 (the \"License.\")\n *\n * You may obtain a copy of the License at http://www.apache.org/licenses/LICENSE-2.0.\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n *\n * See the License for the specific language governing permissions and limitations under the License.\n */\n\n/* eslint max-params: [2, 16], max-statements: [2, 20] */\n// BaseLoginRouter contains the more complicated router logic - rendering/\n// transition, etc. Most router changes should happen in LoginRouter (which is\n// responsible for adding new routes)\nimport { _, $, Backbone, Router, loc } from 'okta';\nimport AppState from 'v1/models/AppState';\nimport Settings from 'models/Settings';\nimport Bundles from 'util/Bundles';\nimport Logger from 'util/Logger';\nimport AuthContainer from 'v1/views/shared/AuthContainer';\nimport Header from 'v1/views/shared/Header';\nimport SecurityBeacon from 'v1/views/shared/SecurityBeacon';\nimport Animations from 'util/Animations';\nimport BrowserFeatures from 'util/BrowserFeatures';\nimport ColorsUtil from 'util/ColorsUtil';\nimport Enums from 'util/Enums';\nimport { ConfigError } from 'util/Errors';\nimport RouterUtil from 'v1/util/RouterUtil';\nimport Util from 'util/Util';\nimport LanguageUtil from 'util/LanguageUtil';\n\nfunction isStateLessRouteHandler(router, fn) {\n  return _.find(router.stateLessRouteHandlers, function(routeName) {\n    return fn === router[routeName];\n  });\n}\n\nfunction beaconIsAvailable(Beacon, settings) {\n  if (!Beacon) {\n    return false;\n  }\n  if (Beacon === SecurityBeacon) {\n    return settings.get('features.securityImage');\n  }\n  return true;\n}\n\nexport default Router.extend({\n  Events: Backbone.Events,\n\n  initialize: function(options) {\n    // Create a default success and/or error handler if\n    // one is not provided.\n    if (!options.globalSuccessFn) {\n      options.globalSuccessFn = function() {};\n    }\n    if (!options.globalErrorFn) {\n      options.globalErrorFn = function(err) {\n        Logger.error(err);\n      };\n    }\n\n    this.settings = new Settings(_.omit(options, 'el', 'authClient'), { parse: true });\n    this.settings.setAuthClient(options.authClient);\n\n    if (!options.el) {\n      this.settings.callGlobalError(new ConfigError(loc('error.required.el')));\n    }\n\n    $('body > div').on('click', function() {\n      // OKTA-69769 Tooltip wont close on iPhone/iPad\n      // Registering a click handler on the first div\n      // allows a tap that falls outside the tooltip\n      // to be registered as a tap by iOS\n      // and then the open tooltip will lose focus and close.\n    });\n\n    this.appState = new AppState(\n      {\n        baseUrl: this.settings.get('baseUrl'),\n        settings: this.settings,\n      },\n      { parse: true }\n    );\n\n    const wrapper = new AuthContainer({ appState: this.appState });\n\n    $(options.el).append(wrapper.render().$el);\n    this.el = `#${Enums.WIDGET_CONTAINER_ID}`;\n\n    this.header = new Header({\n      el: this.el,\n      appState: this.appState,\n      settings: this.settings,\n    });\n\n    // Hide until unitial render\n    this.hide();\n\n    this.listenTo(this.appState, 'change:transactionError', function(appState, err) {\n      RouterUtil.routeAfterAuthStatusChangeError(this, err);\n    });\n\n    this.listenTo(this.appState, 'change:transaction', function(appState, trans) {\n      RouterUtil.routeAfterAuthStatusChange(this, trans.data);\n    });\n\n    this.listenTo(this.appState, 'navigate', function(url) {\n      this.navigate(url, { trigger: true });\n    });\n  },\n\n  execute: function(cb, args) {\n    const recoveryToken = this.settings.get('recoveryToken');\n    // Recovery flow with a token passed through widget settings\n\n    if (recoveryToken) {\n      this.settings.unset('recoveryToken');\n      this.navigate(RouterUtil.createRecoveryUrl(recoveryToken), { trigger: true });\n      return;\n    }\n\n    // Refresh flow with a stateToken passed through widget settings\n    const stateToken = this.settings.get('stateToken');\n\n    if (stateToken) {\n      this.settings.unset('stateToken');\n      this.navigate(RouterUtil.createRefreshUrl(stateToken), { trigger: true });\n      return;\n    }\n\n    // Normal flow - we've either navigated to a stateless page, or are\n    // in the middle of an auth flow\n    const trans = this.appState.get('transaction');\n\n    if ((trans && trans.data) || isStateLessRouteHandler(this, cb)) {\n      cb.apply(this, args);\n      return;\n    }\n\n    // StateToken cookie exists on page load, and we are on a stateful url\n    if (this.settings.getAuthClient().tx.exists()) {\n      this.navigate(RouterUtil.createRefreshUrl(), { trigger: true });\n      return;\n    }\n\n    // We've hit a page that requires state, but have no stateToken - redirect\n    // back to primary auth\n    this.navigate('', { trigger: true });\n  },\n\n  // Overriding the default navigate method to allow the widget consumer\n  // to \"turn off\" routing - if features.router is false, the browser\n  // location bar will not update when the router navigates\n  navigate: function(fragment, options) {\n    if (this.settings.get('features.router')) {\n      return Router.prototype.navigate.apply(this, arguments);\n    }\n    if (options && options.trigger) {\n      return Backbone.history.loadUrl(fragment);\n    }\n  },\n\n  render: function(Controller, options) {\n    options || (options = {});\n\n    let Beacon = options.Beacon;\n\n    const controllerOptions = _.extend({ settings: this.settings, appState: this.appState }, _.omit(options, 'Beacon'));\n\n    // Since we have a wrapper view, render our wrapper and use its content\n    // element as our new el.\n    // Note: Render it here because we know dom is ready at this point\n    if (!this.header.rendered()) {\n      this.el = this.header.render().getContentEl();\n    }\n\n    // If we need to load a language (or apply custom i18n overrides), do\n    // this now and re-run render after it's finished.\n    if (!Bundles.isLoaded(this.appState.get('languageCode'))) {\n      return LanguageUtil.loadLanguage(this.appState, this.settings)\n        .then(_.bind(this.render, this, Controller, options));\n    }\n\n    // Load the custom colors only on the first render\n    if (this.settings.get('colors.brand') && !ColorsUtil.isLoaded()) {\n      const colors = {\n        brand: this.settings.get('colors.brand'),\n      };\n\n      ColorsUtil.addStyle(colors);\n    }\n\n    const oldController = this.controller;\n\n    this.controller = new Controller(controllerOptions);\n\n    // Bubble up all controller events\n    this.listenTo(this.controller, 'all', this.trigger);\n\n    // First run fetchInitialData, in case the next controller needs data\n    // before it's initial render. This will leave the current page in a\n    // loading state.\n    return this.controller\n      .fetchInitialData()\n      .then(() => {\n        // Beacon transition occurs in parallel to page swap\n        if (!beaconIsAvailable(Beacon, this.settings)) {\n          Beacon = null;\n        }\n        this.header.setBeacon(Beacon, controllerOptions);\n\n        // Show before initial render\n        this.show();\n\n        this.controller.render();\n\n        if (!oldController) {\n          this.el.append(this.controller.el);\n          this.controller.postRenderAnimation();\n          return;\n        }\n\n        return Animations.swapPages({\n          $parent: this.el,\n          $oldRoot: oldController.$el,\n          $newRoot: this.controller.$el,\n          dir: oldController.state.get('navigateDir'),\n          ctx: this,\n          success: function() {\n            const flashError = this.appState.get('flashError');\n            const model = this.controller.model;\n\n            oldController.remove();\n            oldController.$el.remove();\n            this.controller.postRenderAnimation();\n            if (flashError) {\n              let errorSummary;\n              const isTerminalError = flashError.is && flashError.is('terminal');\n              if (isTerminalError) {\n                errorSummary = flashError.errorDetails.errorSummary;\n              } else {\n                errorSummary = loc((this.settings.get('features.mfaOnlyFlow')) ?\n                  'error.mfa.only.expired.session' : 'error.expired.session');\n              }\n              model.trigger('error', model, {\n                responseJSON: {\n                  errorSummary\n                },\n              });\n              this.appState.unset('flashError');\n              Util.triggerAfterError(this.controller, flashError);\n            }\n          },\n        });\n      })\n      .catch(function() {\n        // OKTA-69665 - if an error occurs in fetchInitialData, we're left in\n        // a state with two active controllers. Therefore, we clean up the\n        // old one. Note: This explicitly handles the invalid token case -\n        // if we get some other type of error which doesn't force a redirect,\n        // we will probably be left in a bad state. I.e. old controller is\n        // dropped and new controller is not rendered.\n        if (oldController) {\n          oldController.remove();\n          oldController.$el.remove();\n        }\n      });\n  },\n\n  start: function() {\n    let pushState = false;\n\n    // Support for browser's back button.\n    if (window.addEventListener && this.settings.get('features.router')) {\n      window.addEventListener('popstate', e => {\n        if (this.controller.back) {\n          e.preventDefault();\n          e.stopImmediatePropagation();\n          this.controller.back();\n        }\n      });\n      pushState = BrowserFeatures.supportsPushState();\n    }\n    Router.prototype.start.call(this, { pushState: pushState });\n  },\n\n  hide: function() {\n    this.header.$el.hide();\n  },\n\n  show: function() {\n    this.header.$el.show();\n  },\n\n  remove: function() {\n    if (this.controller) {\n      this.controller.remove();\n    }\n    this.header.$el.remove();\n    Bundles.remove();\n    Backbone.history.stop();\n  },\n});\n"],"names":["isStateLessRouteHandler","router","fn","_","find","stateLessRouteHandlers","routeName","beaconIsAvailable","Beacon","settings","SecurityBeacon","get","Router","extend","Events","Backbone","initialize","options","globalSuccessFn","globalErrorFn","err","Logger","error","Settings","omit","parse","setAuthClient","authClient","el","callGlobalError","ConfigError","loc","$","on","appState","AppState","baseUrl","wrapper","AuthContainer","append","render","$el","Enums","WIDGET_CONTAINER_ID","header","Header","hide","listenTo","RouterUtil","routeAfterAuthStatusChangeError","trans","routeAfterAuthStatusChange","data","url","navigate","trigger","execute","cb","args","recoveryToken","unset","createRecoveryUrl","stateToken","createRefreshUrl","apply","getAuthClient","tx","exists","fragment","prototype","arguments","history","loadUrl","Controller","controllerOptions","rendered","getContentEl","Bundles","isLoaded","LanguageUtil","loadLanguage","then","bind","ColorsUtil","colors","brand","addStyle","oldController","controller","fetchInitialData","setBeacon","show","postRenderAnimation","Animations","swapPages","$parent","$oldRoot","$newRoot","dir","state","ctx","success","flashError","model","remove","errorSummary","isTerminalError","is","errorDetails","responseJSON","Util","triggerAfterError","catch","start","pushState","window","addEventListener","e","back","preventDefault","stopImmediatePropagation","BrowserFeatures","supportsPushState","call","stop"],"mappings":"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"}
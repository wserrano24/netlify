{"version":3,"file":"EnrollDuoController.js","sources":["../../../../../src/v1/controllers/EnrollDuoController.js"],"sourcesContent":["/*!\n * Copyright (c) 2015-2016, Okta, Inc. and/or its affiliates. All rights reserved.\n * The Okta software accompanied by this notice is provided pursuant to the Apache License, Version 2.0 (the \"License.\")\n *\n * You may obtain a copy of the License at http://www.apache.org/licenses/LICENSE-2.0.\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n *\n * See the License for the specific language governing permissions and limitations under the License.\n */\n\n/* eslint camelcase: 0*/\nimport { $, _, loc } from 'okta';\nimport Duo from 'duo';\nimport Q from 'q';\nimport FormController from 'v1/util/FormController';\nimport Footer from 'v1/views/enroll-factors/Footer';\nexport default FormController.extend({\n  className: 'enroll-duo duo-form',\n\n  Model: {\n    props: {\n      host: 'string',\n      signature: 'string',\n      postAction: 'string',\n      factorId: 'string',\n      stateToken: 'string',\n    },\n\n    getInitOptions: function() {\n      return this.doTransaction(function(transaction) {\n        const factor = _.findWhere(transaction.factors, {\n          factorType: 'web',\n          provider: 'DUO',\n        });\n\n        return factor.enroll();\n      });\n    },\n\n    activate: function(signedResponse) {\n      const url = this.get('postAction');\n      const factorId = this.get('factorId');\n      const self = this;\n      const data = {\n        id: factorId,\n        stateToken: this.get('stateToken'),\n        sig_response: signedResponse,\n      };\n      // Note: We should be doing this in OktaAuth! Fix when it's updated.\n\n      // We don't actually use authClient.post() here (unlike all the other cases in the\n      // sign-in widget) since the endpoint is wired to accept serialized form post instead\n      // of a JSON post ($.post() is different from authClient.post() in that in $.post(),\n      // jquery decides the Content-Type instead of it being a JSON type). Enroll/Verify DUO\n      // are the only two places where we actually do this.\n      // NOTE - If we ever decide to change this, we should test this very carefully.\n      return Q($.post(url, data))\n        .then(function() {\n          return self.doTransaction(function(transaction) {\n            return transaction.poll();\n          });\n        })\n        .catch(function(err) {\n          self.trigger('error', self, err.xhr);\n        });\n    },\n  },\n\n  Form: {\n    autoSave: true,\n    noButtonBar: true,\n    title: _.partial(loc, 'enroll.duo.title', 'login'),\n\n    postRender: function() {\n      this.add('<iframe frameborder=\"0\" title=\"' + this.title() + '\"></iframe>');\n      Duo.init({\n        host: this.model.get('host'),\n        sig_request: this.model.get('signature'),\n        iframe: this.$('iframe').get(0),\n        post_action: _.bind(this.model.activate, this.model),\n      });\n    },\n  },\n\n  Footer: Footer,\n\n  fetchInitialData: function() {\n    const self = this;\n\n    return this.model.getInitOptions(this.options.appState).then(function(trans) {\n      const res = trans.data;\n\n      if (\n        !res ||\n        !res._embedded ||\n        !res._embedded.factor ||\n        !res._embedded.factor._embedded ||\n        !res._embedded.factor._embedded.activation\n      ) {\n        throw new Error('Response does not have duo activation options');\n      }\n\n      const factor = res._embedded.factor;\n      const activation = factor._embedded.activation;\n\n      self.model.set({\n        host: activation.host,\n        signature: activation.signature,\n        postAction: activation._links.complete.href,\n        factorId: factor.id,\n        stateToken: res.stateToken,\n      });\n    });\n  },\n\n  trapAuthResponse: function() {\n    if (this.options.appState.get('isMfaEnrollActivate')) {\n      return true;\n    }\n  },\n});\n"],"names":["FormController","extend","className","Model","props","host","signature","postAction","factorId","stateToken","getInitOptions","doTransaction","transaction","factor","_","findWhere","factors","factorType","provider","enroll","activate","signedResponse","url","get","self","data","id","sig_response","Q","$","post","then","poll","catch","err","trigger","xhr","Form","autoSave","noButtonBar","title","partial","loc","postRender","add","Duo","init","model","sig_request","iframe","post_action","bind","Footer","fetchInitialData","options","appState","trans","res","_embedded","activation","Error","set","_links","complete","href","trapAuthResponse"],"mappings":"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"}
{"version":3,"file":"RecoveryChallengeController.js","sources":["../../../../../src/v1/controllers/RecoveryChallengeController.js"],"sourcesContent":["/*!\n * Copyright (c) 2015-2016, Okta, Inc. and/or its affiliates. All rights reserved.\n * The Okta software accompanied by this notice is provided pursuant to the Apache License, Version 2.0 (the \"License.\")\n *\n * You may obtain a copy of the License at http://www.apache.org/licenses/LICENSE-2.0.\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n *\n * See the License for the specific language governing permissions and limitations under the License.\n */\n\nimport { _, loc, View } from 'okta';\nimport hbs from 'handlebars-inline-precompile';\nimport Enums from 'util/Enums';\nimport FormController from 'v1/util/FormController';\nimport FormType from 'v1/util/FormType';\nimport FooterSignout from 'v1/views/shared/FooterSignout';\nimport TextBox from 'v1/views/shared/TextBox';\nexport default FormController.extend({\n  className: 'recovery-challenge',\n  Model: {\n    props: {\n      passCode: ['string', true],\n    },\n    local: {\n      ableToResend: 'boolean',\n    },\n    resendCode: function() {\n      // Note: This does not require a trapAuthResponse because Backbone's\n      // router will not navigate if the url path is the same\n      this.limitResending();\n      return this.doTransaction(function(transaction) {\n        return transaction.resend();\n      });\n    },\n    limitResending: function() {\n      this.set({ ableToResend: false });\n      _.delay(_.bind(this.set, this), Enums.API_RATE_LIMIT, { ableToResend: true });\n    },\n    save: function() {\n      return this.doTransaction(function(transaction) {\n        return transaction.verify({\n          passCode: this.get('passCode'),\n        });\n      });\n    },\n  },\n  Form: {\n    autoSave: true,\n    save: _.partial(loc, 'mfa.challenge.verify', 'login'),\n    title: function() {\n      if (this.options.appState.get('factorType') === Enums.RECOVERY_FACTOR_TYPE_CALL) {\n        return loc('recoveryChallenge.call.title', 'login');\n      } else {\n        return loc('recoveryChallenge.sms.title', 'login');\n      }\n    },\n    className: 'recovery-challenge',\n    initialize: function() {\n      this.listenTo(this.model, 'error', function() {\n        this.clearErrors();\n      });\n    },\n    formChildren: function() {\n      return [\n        FormType.Button({\n          title: loc('mfa.resendCode', 'login'),\n          attributes: { 'data-se': 'resend-button' },\n          className: 'button sms-request-button margin-top-30',\n          click: function() {\n            this.model.resendCode();\n          },\n          initialize: function() {\n            this.listenTo(this.model, 'change:ableToResend', function(model, ableToResend) {\n              if (ableToResend) {\n                this.options.title = loc('mfa.resendCode', 'login');\n                this.enable();\n                this.render();\n              } else {\n                this.options.title = loc('mfa.sent', 'login');\n                this.disable();\n                this.render();\n              }\n            });\n          },\n        }),\n        FormType.Input({\n          label: loc('mfa.challenge.enterCode.placeholder', 'login'),\n          'label-top': true,\n          className: 'enroll-sms-phone',\n          name: 'passCode',\n          input: TextBox,\n          type: 'text',\n        }),\n      ];\n    },\n  },\n\n  events: {\n    'click .send-email-link': function(e) {\n      e.preventDefault();\n      const settings = this.model.settings;\n      const username = this.options.appState.get('username');\n      const recoveryType = this.options.appState.get('recoveryType');\n\n      this.model.startTransaction(function(authClient) {\n        // The user could have landed here via the Forgot Password/Unlock Account flow\n        switch (recoveryType) {\n        case Enums.RECOVERY_TYPE_PASSWORD:\n          return authClient.forgotPassword({\n            username: settings.transformUsername(username, Enums.FORGOT_PASSWORD),\n            factorType: Enums.RECOVERY_FACTOR_TYPE_EMAIL,\n          });\n        case Enums.RECOVERY_TYPE_UNLOCK:\n          return authClient.unlockAccount({\n            username: settings.transformUsername(username, Enums.UNLOCK_ACCOUNT),\n            factorType: Enums.RECOVERY_FACTOR_TYPE_EMAIL,\n          });\n        default:\n          return;\n        }\n      });\n    },\n  },\n\n  initialize: function() {\n    const recoveryType = this.options.appState.get('recoveryType');\n    let sendEmailLink;\n\n    switch (recoveryType) {\n    case Enums.RECOVERY_TYPE_PASSWORD:\n      sendEmailLink = hbs`{{i18n code=\"password.forgot.code.notReceived\" bundle=\"login\"}}`;\n      break;\n    case Enums.RECOVERY_TYPE_UNLOCK:\n      sendEmailLink = hbs`{{i18n code=\"account.unlock.code.notReceived\" bundle=\"login\"}}`;\n      break;\n    default:\n      break;\n    }\n\n    if (sendEmailLink && this.settings.get('features.emailRecovery')) {\n      this.add(\n        View.extend({\n          className: 'link send-email-link',\n          tagName: 'a',\n          attributes: {\n            href: '#',\n            'data-se': 'send-email-link',\n          },\n          template: sendEmailLink,\n        })\n      );\n    }\n\n    if (!this.settings.get('features.hideBackToSignInForReset')) {\n      this.addFooter(FooterSignout);\n    }\n  },\n\n  postRender: function() {\n    this.model.limitResending();\n  },\n});\n"],"names":["FormController","extend","className","Model","props","passCode","local","ableToResend","resendCode","limitResending","doTransaction","transaction","resend","set","_","delay","bind","Enums","API_RATE_LIMIT","save","verify","get","Form","autoSave","partial","loc","title","options","appState","RECOVERY_FACTOR_TYPE_CALL","initialize","listenTo","model","clearErrors","formChildren","FormType","Button","attributes","click","enable","render","disable","Input","label","name","input","TextBox","type","events","e","preventDefault","settings","username","recoveryType","startTransaction","authClient","RECOVERY_TYPE_PASSWORD","forgotPassword","transformUsername","FORGOT_PASSWORD","factorType","RECOVERY_FACTOR_TYPE_EMAIL","RECOVERY_TYPE_UNLOCK","unlockAccount","UNLOCK_ACCOUNT","sendEmailLink","add","View","tagName","href","template","addFooter","FooterSignout","postRender"],"mappings":"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"}
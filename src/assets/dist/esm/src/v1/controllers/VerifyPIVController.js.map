{"version":3,"file":"VerifyPIVController.js","sources":["../../../../../src/v1/controllers/VerifyPIVController.js"],"sourcesContent":["/*!\n * Copyright (c) 2019, Okta, Inc. and/or its affiliates. All rights reserved.\n * The Okta software accompanied by this notice is provided pursuant to the Apache License, Version 2.0 (the \"License.\")\n *\n * You may obtain a copy of the License at http://www.apache.org/licenses/LICENSE-2.0.\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n *\n * See the License for the specific language governing permissions and limitations under the License.\n */\n\n/* eslint complexity:[2, 10], max-params: [2, 11] */\nimport { _, $, loc, View, internal } from 'okta';\nimport hbs from 'handlebars-inline-precompile';\nimport FormController from 'v1/util/FormController';\nimport FormType from 'v1/util/FormType';\nimport FooterWithBackLink from 'v1/views/shared/FooterWithBackLink';\nlet { Util } = internal.util;\nexport default FormController.extend({\n  className: 'piv-cac-card',\n  Model: {\n    save: async function() {\n      this.trigger('request');\n      const self = this;\n      const pivConfig = this.settings.get('piv');\n      const data = {\n        fromURI: this.settings.get('relayState'),\n        isCustomDomain: pivConfig.isCustomDomain,\n      };\n\n      try {\n        await this.getCert(pivConfig.certAuthUrl);\n        const res = await this.postCert(pivConfig.certAuthUrl, data);\n        Util.redirect(res.redirectUrl);\n      } catch (err) {\n        if (_.isEmpty(err.responseJSON) && !err.responseText) {\n          err.responseJSON = {\n            errorSummary: loc('piv.cac.error', 'login'),\n          };\n        }\n        self.trigger('error', self, err);\n      }\n    },\n\n    getCert: function(certAuthUrl) {\n      return $.get({\n        url: certAuthUrl,\n        xhrFields: {\n          withCredentials: true,\n        },\n        beforeSend: function() {\n          // overriding this function to prevent our jquery-wrapper from\n          // setting headers. Need to keep this a simple request in order for\n          // PIV / CAC to work in IE.\n        },\n      });\n    },\n\n    postCert: function(certAuthUrl, data) {\n      return $.post({\n        url: certAuthUrl,\n        xhrFields: {\n          withCredentials: true,\n        },\n        data: JSON.stringify(data),\n        contentType: 'text/plain',\n        beforeSend: function() {\n          // overriding this function to prevent our jquery-wrapper from\n          // setting headers. Need to keep this a simple request in order for\n          // PIV / CAC to work in IE.\n        },\n      });\n    },\n  },\n\n  Form: {\n    autoSave: true,\n    hasSavingState: false,\n    title: _.partial(loc, 'piv.cac.title', 'login'),\n    className: 'piv-cac-card',\n    noCancelButton: true,\n    save: _.partial(loc, 'retry', 'login'),\n    modelEvents: {\n      request: '_startEnrollment',\n      error: '_stopEnrollment',\n    },\n\n    formChildren: [\n      FormType.View({\n        View: View.extend({\n          template: hbs(\n            '<div class=\"piv-verify-text\">\\\n               <p>{{i18n code=\"piv.cac.card.insert\" bundle=\"login\"}}</p>\\\n               <div data-se=\"piv-waiting\" class=\"okta-waiting-spinner\"></div>\\\n             </div>'\n          ),\n        }),\n      }),\n    ],\n\n    _startEnrollment: function() {\n      this.$('.okta-waiting-spinner').show();\n      this.$('.o-form-button-bar').hide();\n    },\n\n    _stopEnrollment: function() {\n      this.$('.okta-waiting-spinner').hide();\n      this.$('.o-form-button-bar').show();\n    },\n\n    postRender: function() {\n      _.defer(() => {\n        this.model.save();\n      });\n    },\n  },\n\n  back: function() {\n    // Empty function on verify controllers to prevent users\n    // from navigating back during 'verify' using the browser's\n    // back button. The URL will still change, but the view will not\n    // More details in OKTA-135060.\n  },\n\n  Footer: FooterWithBackLink,\n});\n"],"names":["Util","internal","util","FormController","extend","className","Model","save","trigger","self","pivConfig","settings","get","data","fromURI","isCustomDomain","getCert","certAuthUrl","res","postCert","redirect","redirectUrl","err","_","isEmpty","responseJSON","responseText","errorSummary","loc","$","url","xhrFields","withCredentials","beforeSend","post","JSON","stringify","contentType","Form","autoSave","hasSavingState","title","partial","noCancelButton","modelEvents","request","error","formChildren","FormType","View","template","_startEnrollment","show","hide","_stopEnrollment","postRender","defer","model","back","Footer","FooterWithBackLink"],"mappings":"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"}
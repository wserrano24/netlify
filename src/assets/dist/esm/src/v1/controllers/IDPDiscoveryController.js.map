{"version":3,"file":"IDPDiscoveryController.js","sources":["../../../../../src/v1/controllers/IDPDiscoveryController.js"],"sourcesContent":["/*!\n * Copyright (c) 2015-2017, Okta, Inc. and/or its affiliates. All rights reserved.\n * The Okta software accompanied by this notice is provided pursuant to the Apache License, Version 2.0 (the \"License.\")\n *\n * You may obtain a copy of the License at http://www.apache.org/licenses/LICENSE-2.0.\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n *\n * See the License for the specific language governing permissions and limitations under the License.\n */\n\nimport PrimaryAuthController from 'v1/controllers/PrimaryAuthController';\nimport IDPDiscoveryModel from 'v1/models/IDPDiscovery';\nimport PrimaryAuthModel from 'v1/models/PrimaryAuth';\nimport BaseLoginController from 'v1/util/BaseLoginController';\nimport IDPDiscoveryForm from 'v1/views/idp-discovery/IDPDiscoveryForm';\nimport CustomButtons from 'v1/views/primary-auth/CustomButtons';\nimport DeviceFingerprint from 'v1/util/DeviceFingerprint';\nimport Util from 'util/Util';\n\nexport default PrimaryAuthController.extend({\n  className: 'idp-discovery',\n\n  View: IDPDiscoveryForm,\n\n  constructor: function(options) {\n    options.appState.unset('username');\n    let requestContext = options.settings.get('idpDiscovery.requestContext');\n    const lastAuthResponse = options.appState.get('lastAuthResponse');\n    const stateToken = lastAuthResponse && lastAuthResponse?.stateToken;\n\n    //Update requestContext with last stateToken, if the context was stateToken and not a fromUri\n    if(Util.isV1StateToken(requestContext)) {\n      requestContext = stateToken;\n    }\n\n    this.model = new IDPDiscoveryModel(\n      {\n        requestContext: requestContext,\n        settings: options.settings,\n        appState: options.appState,\n      },\n      { parse: true }\n    );\n\n    BaseLoginController.apply(this, arguments);\n\n    this.addListeners();\n\n    // If social auth is configured, 'socialAuthPositionTop' will determine\n    // the order in which the social auth and primary auth are shown on the screen.\n    if (options.settings.get('hasConfiguredButtons')) {\n      this.add(CustomButtons, {\n        prepend: options.settings.get('socialAuthPositionTop'),\n        options: {\n          // To trigger an afterError event, we require the current controller\n          currentController: this,\n        },\n      });\n    }\n\n    this.addFooter(options);\n\n    this.setUsername();\n  },\n\n  initialize: function() {\n    PrimaryAuthController.prototype.initialize.apply(this);\n\n    this.listenTo(this.model, 'goToPrimaryAuth', function() {\n      this.settings.set('username', this.model.get('username'));\n      const self = this;\n      if (this.settings.get('features.deviceFingerprinting')) {\n        DeviceFingerprint.generateDeviceFingerprint(this.settings.get('baseUrl'), this.$el)\n          .then(function(fingerprint) {\n            self.options.appState.set('deviceFingerprint', fingerprint);\n            self.options.appState.set('username', self.model.get('username'));\n          })\n          .catch(function() {\n          // Keep going even if device fingerprint fails\n            self.options.appState.set('username', self.model.get('username'));\n          })\n          .finally(function() {\n            self.doPrimaryAuth();\n          });\n      } else {\n        self.doPrimaryAuth();\n      }\n    });\n  },\n\n  doPrimaryAuth : function() {\n    if (this.settings.get('features.passwordlessAuth')) {\n      const primaryAuthModel = new PrimaryAuthModel(\n        {\n          username: this.model.get('username'),\n          multiOptionalFactorEnroll: this.options.settings.get('features.multiOptionalFactorEnroll'),\n          settings: this.options.settings,\n          appState: this.options.appState,\n        },\n        { parse: true }\n      );\n\n      // Events to set the transaction attributes on the app state.\n      this.listenTo(primaryAuthModel, 'error', function(src, errObj) {\n        this.toggleButtonState(false);\n        this.model.trigger('error', this.model, errObj);\n      });\n      this.addModelListeners(primaryAuthModel);\n      // Make the primary auth request\n      primaryAuthModel.save();\n    } else {\n      this.options.appState.set('disableUsername', true);\n      this.options.appState.trigger('navigate', 'signin');\n    }\n  },\n\n});\n"],"names":["PrimaryAuthController","extend","className","View","IDPDiscoveryForm","constructor","options","appState","unset","requestContext","settings","get","lastAuthResponse","stateToken","Util","isV1StateToken","model","IDPDiscoveryModel","parse","BaseLoginController","apply","arguments","addListeners","add","CustomButtons","prepend","currentController","addFooter","setUsername","initialize","prototype","listenTo","set","self","DeviceFingerprint","generateDeviceFingerprint","$el","then","fingerprint","catch","finally","doPrimaryAuth","primaryAuthModel","PrimaryAuthModel","username","multiOptionalFactorEnroll","src","errObj","toggleButtonState","trigger","addModelListeners","save"],"mappings":"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"}
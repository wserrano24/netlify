{"version":3,"file":"VerifyCustomFactorController.js","sources":["../../../../../src/v1/controllers/VerifyCustomFactorController.js"],"sourcesContent":["/*!\n * Copyright (c) 2018-2019, Okta, Inc. and/or its affiliates. All rights reserved.\n * The Okta software accompanied by this notice is provided pursuant to the Apache License, Version 2.0 (the \"License.\")\n *\n * You may obtain a copy of the License at http://www.apache.org/licenses/LICENSE-2.0.\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n *\n * See the License for the specific language governing permissions and limitations under the License.\n */\n\nimport { _, loc, internal } from 'okta';\nimport FactorUtil from 'util/FactorUtil';\nimport FormController from 'v1/util/FormController';\nimport FormType from 'v1/util/FormType';\nimport HtmlErrorMessageView from 'v1/views/mfa-verify/HtmlErrorMessageView';\nimport FooterMFA from 'v1/views/shared/FooterMFA';\nconst { Util } = internal.util;\nexport default FormController.extend({\n  className: 'verify-custom-factor custom-factor-form',\n\n  Model: {\n    props: {\n      rememberDevice: 'boolean',\n    },\n\n    initialize: function() {\n      const rememberDevice = FactorUtil.getRememberDeviceValue(this.appState);\n\n      // set the initial value for remember device (Cannot do this while defining the\n      // local property because this.settings would not be initialized there yet).\n      this.set('rememberDevice', rememberDevice);\n      if (this.settings.get('features.skipIdpFactorVerificationBtn') &&\n        !this.appState.get('lastFailedChallengeFactorData')) {\n        this.set('provider', 'CUSTOM');\n        this.set('factorType', 'claims_provider');\n        this.save();\n      }\n    },\n\n    save: function() {\n      const rememberDevice = !!this.get('rememberDevice');\n\n      return this.manageTransaction((transaction, setTransaction) => {\n        const data = {\n          rememberDevice: rememberDevice,\n        };\n\n        const factor = _.findWhere(transaction.factors, {\n          provider: this.get('provider'),\n          factorType: this.get('factorType'),\n        });\n\n        return factor\n          .verify(data)\n          .then(trans => {\n            setTransaction(trans);\n            const url = this.appState.get('verifyCustomFactorRedirectUrl');\n\n            if (url !== null) {\n              Util.redirect(url);\n            }\n          })\n          .catch(function(err) {\n            throw err;\n          });\n      });\n    },\n  },\n\n  Form: function() {\n    const factors = this.options.appState.get('factors');\n    const factor = factors.findWhere({\n      provider: this.options.provider,\n      factorType: this.options.factorType,\n    });\n    const vendorName = factor.get('vendorName');\n    const saveText = loc('mfa.challenge.verify', 'login');\n    const lastFailedChallengeFactorData = this.options.appState.get('lastFailedChallengeFactorData');\n    let subtitle = loc('verify.customFactor.subtitle', 'login', [vendorName]);\n\n    if (this.settings.get('features.skipIdpFactorVerificationBtn') && !lastFailedChallengeFactorData) {\n      subtitle = loc('verify.customFactor.subtitle.redirect', 'login', [vendorName]);\n\n      this.listenTo(this.model, 'error', () => {\n        subtitle = loc('verify.customFactor.subtitle', 'login', [vendorName]);\n        this.$('.o-form-explain').text(subtitle);\n      });\n    }\n    return {\n      autoSave: true,\n      title: vendorName,\n      save: saveText,\n      subtitle: subtitle,\n      attributes: { 'data-se': 'factor-custom' },\n      initialize: function() {\n        if (this.options.appState.get('allowRememberDevice')) {\n          this.addInput({\n            label: false,\n            'label-top': true,\n            placeholder: this.options.appState.get('rememberDeviceLabel'),\n            className: 'margin-btm-0',\n            name: 'rememberDevice',\n            type: 'checkbox',\n          });\n        }\n      },\n\n      formChildren: function() {\n        const result = [];\n        const lastFailedChallengeFactorData = this.options.appState.get('lastFailedChallengeFactorData');\n\n        if (this.settings.get('features.skipIdpFactorVerificationBtn') && !lastFailedChallengeFactorData) {\n          result.push(\n            FormType.View({\n              View:\n                '<div data-se=\"custom-factor-waiting\" class=\"okta-waiting-spinner\"></div>'\n            })\n          );\n        }\n\n        if (lastFailedChallengeFactorData) {\n          result.push(\n            FormType.View(\n              { View: new HtmlErrorMessageView({ message: lastFailedChallengeFactorData.errorMessage }) },\n              { selector: '.o-form-error-container' }\n            )\n          );\n        }\n        return result;\n      },\n    };\n  },\n\n  postRender() {\n    if (this.settings.get('features.skipIdpFactorVerificationBtn') &&\n      !this.options.appState.get('lastFailedChallengeFactorData')) {\n      this.$('.o-form-button-bar').hide();\n      this.$('.okta-waiting-spinner').show();\n    }\n  },\n\n  trapAuthResponse: function() {\n    if (this.options.appState.get('isMfaChallenge')) {\n      return true;\n    }\n  },\n\n  back: function() {\n    // Empty function on verify controllers to prevent users\n    // from navigating back during 'verify' using the browser's\n    // back button. The URL will still change, but the view will not\n    // More details in OKTA-135060.\n  },\n\n  initialize: function() {\n    this.model.set('provider', this.options.provider);\n    this.model.set('factorType', this.options.factorType);\n\n    if (this.settings.get('features.skipIdpFactorVerificationBtn')) {\n      this.listenTo(this.model, 'error', () => {\n        this.$('.okta-waiting-spinner').hide();\n        this.$('.o-form-button-bar').show();\n      });\n    }\n    this.addFooter(FooterMFA);\n  },\n});\n"],"names":["Util","internal","util","FormController","extend","className","Model","props","rememberDevice","initialize","FactorUtil","getRememberDeviceValue","appState","set","settings","get","save","manageTransaction","transaction","setTransaction","data","factor","_","findWhere","factors","provider","factorType","verify","then","trans","url","redirect","catch","err","Form","options","vendorName","saveText","loc","lastFailedChallengeFactorData","subtitle","listenTo","model","$","text","autoSave","title","attributes","addInput","label","placeholder","name","type","formChildren","result","push","FormType","View","HtmlErrorMessageView","message","errorMessage","selector","postRender","hide","show","trapAuthResponse","back","addFooter","FooterMFA"],"mappings":"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"}
{"version":3,"file":"EnrollU2FController.js","sources":["../../../../../src/v1/controllers/EnrollU2FController.js"],"sourcesContent":["/*!\n * Copyright (c) 2015-2016, Okta, Inc. and/or its affiliates. All rights reserved.\n * The Okta software accompanied by this notice is provided pursuant to the Apache License, Version 2.0 (the \"License.\")\n *\n * You may obtain a copy of the License at http://www.apache.org/licenses/LICENSE-2.0.\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n *\n * See the License for the specific language governing permissions and limitations under the License.\n */\n\n/* global u2f */\nimport { _, loc, View } from 'okta';\nimport hbs from 'handlebars-inline-precompile';\nimport Q from 'q';\nimport 'u2f-api-polyfill';\nimport { U2FError } from 'util/Errors';\nimport FidoUtil from 'util/FidoUtil';\nimport FormController from 'v1/util/FormController';\nimport FormType from 'v1/util/FormType';\nimport Footer from 'v1/views/enroll-factors/Footer';\nimport HtmlErrorMessageView from 'v1/views/mfa-verify/HtmlErrorMessageView';\nexport default FormController.extend({\n  className: 'enroll-u2f',\n  Model: {\n    local: {\n      __enrolled__: 'boolean',\n    },\n\n    save: function() {\n      this.trigger('request');\n\n      if (this.get('__enrolled__')) {\n        return this.activate();\n      }\n\n      return this.doTransaction(function(transaction) {\n        const factor = _.findWhere(transaction.factors, {\n          factorType: 'u2f',\n          provider: 'FIDO',\n        });\n\n        return factor.enroll();\n      });\n    },\n\n    activate: function() {\n      this.set('__enrolled__', true);\n      this.trigger('errors:clear');\n\n      return this.doTransaction(function(transaction) {\n        const activation = transaction.factor.activation;\n        const appId = activation.appId;\n        const registerRequests = [\n          {\n            version: FidoUtil.getU2fVersion(),\n            challenge: activation.nonce,\n          },\n        ];\n        const self = this;\n        const deferred = Q.defer();\n\n        u2f.register(appId, registerRequests, [], function(data) {\n          self.trigger('errors:clear');\n          if (data.errorCode && data.errorCode !== 0) {\n            deferred.reject(\n              new U2FError({\n                xhr: {\n                  responseJSON: {\n                    errorSummary: FidoUtil.getU2fEnrollErrorMessageByCode(data.errorCode),\n                  },\n                },\n              })\n            );\n          } else {\n            deferred.resolve(\n              transaction.activate({\n                registrationData: data.registrationData,\n                version: data.version,\n                challenge: data.challenge,\n                clientData: data.clientData,\n              })\n            );\n          }\n        });\n        return deferred.promise;\n      });\n    },\n  },\n\n  Form: {\n    title: _.partial(loc, 'enroll.u2f.title', 'login'),\n    save: _.partial(loc, 'enroll.u2f.save', 'login'),\n    noCancelButton: true,\n    hasSavingState: false,\n    autoSave: true,\n    className: 'enroll-u2f-form',\n    noButtonBar: function() {\n      return !FidoUtil.isU2fAvailable();\n    },\n    modelEvents: {\n      request: '_startEnrollment',\n      error: '_stopEnrollment',\n    },\n    formChildren: function() {\n      const result = [];\n\n      if (!FidoUtil.isU2fAvailable()) {\n        let errorMessageKey = 'u2f.error.factorNotSupported';\n\n        if (this.options.appState.get('factors').length === 1) {\n          errorMessageKey = 'u2f.error.factorNotSupported.oneFactor';\n        }\n        result.push(\n          FormType.View(\n            { View: new HtmlErrorMessageView({ message: loc(errorMessageKey, 'login') }) },\n            { selector: '.o-form-error-container' }\n          )\n        );\n      } else {\n        //There is html in enroll.u2f.general2 in our properties file, reason why is unescaped\n        result.push(\n          FormType.View({\n            View: View.extend({\n              template: hbs(\n                '<div class=\"u2f-instructions\"><ol>\\\n                <li>{{{i18n code=\"enroll.u2f.general2\" bundle=\"login\"}}}</li>\\\n                <li>{{i18n code=\"enroll.u2f.general3\" bundle=\"login\"}}</li>\\\n                </ol></div>'\n              ),\n            }),\n          })\n        );\n\n        result.push(\n          FormType.View({\n            View: View.extend({\n              template: hbs(\n                '\\\n                <div class=\"u2f-enroll-text hide\">\\\n                  <p>{{i18n code=\"enroll.u2f.instructions\" bundle=\"login\"}}</p>\\\n                  <p>{{i18n code=\"enroll.u2f.instructionsBluetooth\" bundle=\"login\"}}</p>\\\n                  <div data-se=\"u2f-devices\" class=\"u2f-devices-images\">\\\n                    <div class=\"u2f-usb\"></div>\\\n                    <div class=\"u2f-bluetooth\"></div>\\\n                  </div>\\\n                  <div data-se=\"u2f-waiting\" class=\"okta-waiting-spinner\"></div>\\\n                </div>'\n              ),\n            }),\n          })\n        );\n      }\n\n      return result;\n    },\n\n    _startEnrollment: function() {\n      this.$('.u2f-instructions').addClass('hide');\n      this.$('.u2f-enroll-text').removeClass('hide');\n      this.$('.o-form-button-bar').hide();\n    },\n\n    _stopEnrollment: function() {\n      this.$('.u2f-instructions').removeClass('hide');\n      this.$('.u2f-enroll-text').addClass('hide');\n      this.$('.o-form-button-bar').show();\n    },\n  },\n\n  Footer: Footer,\n\n  trapAuthResponse: function() {\n    if (this.options.appState.get('isMfaEnrollActivate')) {\n      this.model.activate();\n      return true;\n    }\n  },\n});\n"],"names":["FormController","extend","className","Model","local","__enrolled__","save","trigger","get","activate","doTransaction","transaction","factor","_","findWhere","factors","factorType","provider","enroll","set","activation","appId","registerRequests","version","FidoUtil","getU2fVersion","challenge","nonce","self","deferred","Q","defer","u2f","register","data","errorCode","reject","U2FError","xhr","responseJSON","errorSummary","getU2fEnrollErrorMessageByCode","resolve","registrationData","clientData","promise","Form","title","partial","loc","noCancelButton","hasSavingState","autoSave","noButtonBar","isU2fAvailable","modelEvents","request","error","formChildren","result","errorMessageKey","options","appState","length","push","FormType","View","HtmlErrorMessageView","message","selector","template","_startEnrollment","$","addClass","removeClass","hide","_stopEnrollment","show","Footer","trapAuthResponse","model"],"mappings":"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"}
{"version":3,"file":"EnrollWindowsHelloController.js","sources":["../../../../../src/v1/controllers/EnrollWindowsHelloController.js"],"sourcesContent":["/*!\n * Copyright (c) 2015-2016, Okta, Inc. and/or its affiliates. All rights reserved.\n * The Okta software accompanied by this notice is provided pursuant to the Apache License, Version 2.0 (the \"License.\")\n *\n * You may obtain a copy of the License at http://www.apache.org/licenses/LICENSE-2.0.\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n *\n * See the License for the specific language governing permissions and limitations under the License.\n */\n\nimport { _, loc } from 'okta';\nimport FormController from 'v1/util/FormController';\nimport FormType from 'v1/util/FormType';\nimport webauthn from 'util/webauthn';\nimport Footer from 'v1/views/enroll-factors/Footer';\nimport HtmlErrorMessageView from 'v1/views/mfa-verify/HtmlErrorMessageView';\nimport Spinner from 'v1/views/shared/Spinner';\nexport default FormController.extend({\n  className: 'enroll-windows-hello',\n  Model: {\n    local: {\n      __isEnrolled__: 'boolean',\n    },\n\n    save: function() {\n      if (!webauthn.isAvailable()) {\n        return;\n      }\n\n      this.trigger('request');\n\n      if (this.get('__isEnrolled__')) {\n        return this.activate();\n      }\n\n      return this.doTransaction(function(transaction) {\n        return this._enroll(transaction);\n      });\n    },\n\n    _enroll: function(transaction) {\n      const factor = _.findWhere(transaction.factors, {\n        factorType: 'webauthn',\n        provider: 'FIDO',\n      });\n\n      return factor.enroll();\n    },\n\n    activate: function() {\n      this.set('__isEnrolled__', true);\n\n      return this.doTransaction(function(transaction) {\n        const activation = transaction.factor.activation;\n        const user = transaction.user;\n        const model = this;\n        const accountInfo = {\n          rpDisplayName: activation.rpDisplayName,\n          userDisplayName: user.profile.displayName,\n          accountName: user.profile.login,\n          userId: user.id,\n        };\n        const cryptoParams = [\n          {\n            algorithm: activation.algorithm,\n          },\n        ];\n        const challenge = activation.nonce;\n\n        return webauthn\n          .makeCredential(accountInfo, cryptoParams, challenge)\n          .then(function(creds) {\n            return transaction.activate({\n              credentialId: creds.credential.id,\n              publicKey: creds.publicKey,\n              attestation: null,\n            });\n          })\n          .catch(function(error) {\n            switch (error.message) {\n            case 'AbortError':\n            case 'NotFoundError':\n            case 'NotSupportedError':\n              model.trigger('abort', error.message);\n              return transaction;\n            }\n\n            throw error;\n          });\n      });\n    },\n  },\n\n  Form: {\n    autoSave: true,\n    hasSavingState: false,\n    title: _.partial(loc, 'enroll.windowsHello.title', 'login'),\n    subtitle: function() {\n      return webauthn.isAvailable() ? loc('enroll.windowsHello.subtitle', 'login') : '';\n    },\n    save: _.partial(loc, 'enroll.windowsHello.save', 'login'),\n\n    customSavingState: {\n      stop: 'abort',\n    },\n\n    modelEvents: function() {\n      if (!webauthn.isAvailable()) {\n        return {};\n      }\n\n      return {\n        request: '_startEnrollment',\n        error: '_stopEnrollment',\n        abort: '_stopEnrollment',\n      };\n    },\n\n    noButtonBar: function() {\n      return !webauthn.isAvailable();\n    },\n\n    formChildren: function() {\n      const result = [];\n\n      if (!webauthn.isAvailable()) {\n        result.push(\n          FormType.View(\n            { View: new HtmlErrorMessageView({ message: loc('enroll.windowsHello.error.notWindows', 'login') }) },\n            { selector: '.o-form-error-container' }\n          )\n        );\n      }\n\n      result.push(FormType.View({ View: new Spinner({ model: this.model, visible: false }) }));\n\n      return result;\n    },\n\n    _startEnrollment: function() {\n      this.subtitle = loc('enroll.windowsHello.subtitle.loading', 'login');\n\n      this.model.trigger('spinner:show');\n      this._resetErrorMessage();\n\n      this.render();\n      this.$('.o-form-button-bar').addClass('hide');\n    },\n\n    _stopEnrollment: function(errorMessage) {\n      this.subtitle = loc('enroll.windowsHello.subtitle', 'login');\n\n      this.model.trigger('spinner:hide');\n\n      let message;\n\n      switch (errorMessage) {\n      case 'NotSupportedError':\n        message = loc('enroll.windowsHello.error.notConfiguredHtml', 'login');\n        break;\n      }\n\n      this._resetErrorMessage();\n\n      if (message) {\n        const messageView = new HtmlErrorMessageView({\n          message: message,\n        });\n\n        this.$('.o-form-error-container').addClass('o-form-has-errors');\n        this.add(messageView, { selector: '.o-form-error-container' });\n        this._errorMessageView = this.last();\n      }\n\n      this.render();\n      this.$('.o-form-button-bar').removeClass('hide');\n    },\n\n    _resetErrorMessage: function() {\n      this._errorMessageView && this._errorMessageView.remove();\n      this._errorMessageView = undefined;\n      this.clearErrors();\n    },\n  },\n\n  Footer: Footer,\n\n  trapAuthResponse: function() {\n    if (this.options.appState.get('isMfaEnrollActivate')) {\n      this.model.activate();\n      return true;\n    }\n  },\n});\n"],"names":["FormController","extend","className","Model","local","__isEnrolled__","save","webauthn","isAvailable","trigger","get","activate","doTransaction","transaction","_enroll","factor","_","findWhere","factors","factorType","provider","enroll","set","activation","user","model","accountInfo","rpDisplayName","userDisplayName","profile","displayName","accountName","login","userId","id","cryptoParams","algorithm","challenge","nonce","makeCredential","then","creds","credentialId","credential","publicKey","attestation","catch","error","message","Form","autoSave","hasSavingState","title","partial","loc","subtitle","customSavingState","stop","modelEvents","request","abort","noButtonBar","formChildren","result","push","FormType","View","HtmlErrorMessageView","selector","Spinner","visible","_startEnrollment","_resetErrorMessage","render","$","addClass","_stopEnrollment","errorMessage","messageView","add","_errorMessageView","last","removeClass","remove","undefined","clearErrors","Footer","trapAuthResponse","options","appState"],"mappings":"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"}
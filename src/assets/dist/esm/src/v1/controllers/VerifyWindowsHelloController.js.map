{"version":3,"file":"VerifyWindowsHelloController.js","sources":["../../../../../src/v1/controllers/VerifyWindowsHelloController.js"],"sourcesContent":["/*!\n * Copyright (c) 2015-2016, Okta, Inc. and/or its affiliates. All rights reserved.\n * The Okta software accompanied by this notice is provided pursuant to the Apache License, Version 2.0 (the \"License.\")\n *\n * You may obtain a copy of the License at http://www.apache.org/licenses/LICENSE-2.0.\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n *\n * See the License for the specific language governing permissions and limitations under the License.\n */\n\nimport { _, loc } from 'okta';\nimport FormController from 'v1/util/FormController';\nimport FormType from 'v1/util/FormType';\nimport webauthn from 'util/webauthn';\nimport HtmlErrorMessageView from 'v1/views/mfa-verify/HtmlErrorMessageView';\nimport FooterMFA from 'v1/views/shared/FooterMFA';\nimport Spinner from 'v1/views/shared/Spinner';\nexport default FormController.extend({\n  className: 'mfa-verify verify-windows-hello',\n  Model: {\n    local: {\n      __autoTriggered__: 'boolean',\n    },\n\n    save: function() {\n      if (!webauthn.isAvailable()) {\n        return;\n      }\n\n      this.trigger('request');\n      const model = this;\n\n      return this.doTransaction(function(transaction) {\n        const factor = _.findWhere(transaction.factors, {\n          factorType: 'webauthn',\n          provider: 'FIDO',\n        });\n\n        return factor.verify().then(function(verifyData) {\n          const factorData = verifyData.factor;\n\n          return webauthn\n            .getAssertion(factorData.challenge.nonce, [{ id: factorData.profile.credentialId }])\n            .then(function(assertion) {\n              return factor.verify({\n                authenticatorData: assertion.authenticatorData,\n                clientData: assertion.clientData,\n                signatureData: assertion.signature,\n              });\n            })\n            .then(function(data) {\n              model.trigger('sync');\n              model.trigger('signIn');\n              return data;\n            })\n            .catch(function(error) {\n              switch (error.message) {\n              case 'AbortError':\n              case 'NotFoundError':\n              case 'NotSupportedError':\n                model.trigger('abort', error.message);\n                return transaction;\n              }\n\n              throw error;\n            });\n        });\n      });\n    },\n  },\n\n  Form: {\n    autoSave: true,\n    hasSavingState: false,\n    title: _.partial(loc, 'factor.windowsHello', 'login'),\n    subtitle: function() {\n      return webauthn.isAvailable() ? loc('verify.windowsHello.subtitle', 'login') : '';\n    },\n    save: _.partial(loc, 'verify.windowsHello.save', 'login'),\n\n    customSavingState: {\n      stop: 'abort',\n    },\n\n    modelEvents: function() {\n      if (!webauthn.isAvailable()) {\n        return {};\n      }\n\n      return {\n        request: '_startEnrollment',\n        error: '_stopEnrollment',\n        abort: '_stopEnrollment',\n        signIn: '_successEnrollment',\n      };\n    },\n\n    noButtonBar: function() {\n      return !webauthn.isAvailable();\n    },\n\n    formChildren: function() {\n      const result = [];\n\n      if (!webauthn.isAvailable()) {\n        result.push(\n          FormType.View(\n            { View: new HtmlErrorMessageView({ message: loc('enroll.windowsHello.error.notWindows', 'login') }) },\n            { selector: '.o-form-error-container' }\n          )\n        );\n      }\n\n      result.push(FormType.View({ View: new Spinner({ model: this.model, visible: false }) }));\n\n      return result;\n    },\n\n    postRender: function() {\n      if (this.options.appState.get('factors').length === 1 && !this.model.get('__autoTriggered__')) {\n        this.model.set('__autoTriggered__', true);\n        this.model.save();\n      }\n    },\n\n    _startEnrollment: function() {\n      this.subtitle = loc('verify.windowsHello.subtitle.loading', 'login');\n\n      this.model.trigger('spinner:show');\n      this._resetErrorMessage();\n\n      this.render();\n      this.$('.o-form-button-bar').addClass('hide');\n    },\n\n    _stopEnrollment: function(errorMessage) {\n      this.subtitle = loc('verify.windowsHello.subtitle', 'login');\n\n      this.model.trigger('spinner:hide');\n      this.$('.o-form-button-bar').removeClass('hide');\n\n      let message;\n\n      switch (errorMessage) {\n      case 'NotFoundError':\n        message = this.options.appState.get('factors').length > 1\n          ? loc('verify.windowsHello.error.notFound.selectAnother', 'login')\n          : loc('verify.windowsHello.error.notFound', 'login');\n        break;\n\n      case 'NotSupportedError':\n        message = loc('enroll.windowsHello.error.notConfiguredHtml', 'login');\n        break;\n      }\n\n      this._resetErrorMessage();\n\n      if (message) {\n        const messageView = new HtmlErrorMessageView({\n          message: message,\n        });\n\n        this.$('.o-form-error-container').addClass('o-form-has-errors');\n        this.add(messageView, { selector: '.o-form-error-container' });\n        this._errorMessageView = this.last();\n      }\n\n      this.render();\n    },\n\n    _successEnrollment: function() {\n      this.subtitle = this.settings.get('brandName')\n        ? loc('verify.windowsHello.subtitle.signingIn.specific', 'login', [this.settings.get('brandName')])\n        : loc('verify.windowsHello.subtitle.signingIn.generic', 'login');\n      this.render();\n      this.$('.o-form-button-bar').addClass('hide');\n    },\n\n    _resetErrorMessage: function() {\n      this._errorMessageView && this._errorMessageView.remove();\n      this._errorMessageView = undefined;\n      this.clearErrors();\n    },\n  },\n\n  back: function() {\n    // Empty function on verify controllers to prevent users\n    // from navigating back during 'verify' using the browser's\n    // back button. The URL will still change, but the view will not\n    // More details in OKTA-135060.\n  },\n\n  Footer: FooterMFA,\n});\n"],"names":["FormController","extend","className","Model","local","__autoTriggered__","save","webauthn","isAvailable","trigger","model","doTransaction","transaction","factor","_","findWhere","factors","factorType","provider","verify","then","verifyData","factorData","getAssertion","challenge","nonce","id","profile","credentialId","assertion","authenticatorData","clientData","signatureData","signature","data","catch","error","message","Form","autoSave","hasSavingState","title","partial","loc","subtitle","customSavingState","stop","modelEvents","request","abort","signIn","noButtonBar","formChildren","result","push","FormType","View","HtmlErrorMessageView","selector","Spinner","visible","postRender","options","appState","get","length","set","_startEnrollment","_resetErrorMessage","render","$","addClass","_stopEnrollment","errorMessage","removeClass","messageView","add","_errorMessageView","last","_successEnrollment","settings","remove","undefined","clearErrors","back","Footer","FooterMFA"],"mappings":"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"}
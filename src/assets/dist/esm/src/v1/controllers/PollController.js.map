{"version":3,"file":"PollController.js","sources":["../../../../../src/v1/controllers/PollController.js"],"sourcesContent":["/*!\n * Copyright (c) 2020, Okta, Inc. and/or its affiliates. All rights reserved.\n * The Okta software accompanied by this notice is provided pursuant to the Apache License, Version 2.0 (the \"License.\")\n *\n * You may obtain a copy of the License at http://www.apache.org/licenses/LICENSE-2.0.\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n *\n * See the License for the specific language governing permissions and limitations under the License.\n */\n\nimport { loc } from 'okta';\nimport FormController from 'v1/util/FormController';\nimport FormType from 'v1/util/FormType';\nexport default FormController.extend({\n  className: 'poll',\n  Model: {\n    save: function() {\n      this.trigger('cancelRequest');\n      return this.appState\n        .get('transaction')\n        .cancel()\n        .then(() => {\n          this.options.appState.trigger('navigate', '');\n        })\n        .catch(() => {\n          this._stopCountDown();\n        });\n    },\n  },\n\n  Form: {\n    autoSave: true,\n    hasSavingState: false,\n    title: function() {\n      return this.title;\n    },\n    className: 'poll-controller',\n    noCancelButton: true,\n    save: loc('oform.cancel', 'login'),\n    modelEvents: {\n      cancelRequest: '_stopCountDown',\n    },\n    formChildren: [\n      FormType.View({\n        View: '<div >\\\n               <div data-se=\"poll-waiting\" class=\"hide okta-waiting-spinner\"></div>\\\n             </div>',\n      }),\n    ],\n    _checkStatus: function() {\n      // start polling request\n      this.transactionObject\n        .poll()\n        .then(resp => {\n          if (resp.data && resp.status !== 'POLL') {\n            this.options.appState.set('transaction', resp);\n            return;\n          }\n          this.$('.okta-waiting-spinner').hide();\n          let factorPollingIntervalSeconds = Math.ceil(resp.transaction.profile.refresh / 1000);\n          this._startCountDown(factorPollingIntervalSeconds);\n        })\n        .catch(() => {\n          this._stopCountDown();\n        });\n    },\n\n    _startCountDown: function(factorPollingIntervalSeconds) {\n      // start one second countdown for next poll request\n      this.countDown = setInterval(() => {\n        // update title after every second and check if countdown == 1 to poll again\n        this._updateTitle(factorPollingIntervalSeconds);\n        if (factorPollingIntervalSeconds === 0) {\n          /* when countdown hits 0\n                       - stop current poll\n                       - show spinner\n                       - check status\n                      */\n          this._stopCountDown();\n          this.$('.okta-waiting-spinner').show();\n          // start after a small delay so that the spinner does not get hidden too soon\n          this.checkStatusTimeout = setTimeout(() => {\n            this._checkStatus();\n          }, 200);\n        } else {\n          // reduce countdown after every second\n          factorPollingIntervalSeconds = factorPollingIntervalSeconds - 1;\n        }\n      }, 1000);\n    },\n\n    _updateTitle: function(factorPollingIntervalSeconds) {\n      this.title = loc('polling.title', 'login', [factorPollingIntervalSeconds]);\n      this.$el.find('.okta-form-title').text(this.title);\n    },\n\n    _stopCountDown: function() {\n      // clear countdown setInterval\n      if (this.countDown) {\n        clearInterval(this.countDown);\n      }\n      // clear checkstatus setTimeout\n      if (this.checkStatusTimeout) {\n        clearInterval(this.checkStatusTimeout);\n      }\n    },\n\n    initialize: function(options) {\n      this.transactionObject = options.appState.get('transaction');\n      this.factorPollingIntervalSeconds = Math.ceil(this.transactionObject.transaction.profile.refresh / 1000);\n      this._updateTitle(this.factorPollingIntervalSeconds);\n      this._startCountDown(this.factorPollingIntervalSeconds);\n    },\n  },\n\n  back: function() {\n    // Empty function on verify controllers to prevent users\n    // from navigating back during 'verify' using the browser's\n    // back button. The URL will still change, but the view will not\n    // More details in OKTA-135060.\n  },\n\n  remove: function() {\n    this.form._stopCountDown();\n  },\n});\n"],"names":["FormController","extend","className","Model","save","trigger","appState","get","cancel","then","options","catch","_stopCountDown","Form","autoSave","hasSavingState","title","noCancelButton","loc","modelEvents","cancelRequest","formChildren","FormType","View","_checkStatus","transactionObject","poll","resp","data","status","set","$","hide","factorPollingIntervalSeconds","Math","ceil","transaction","profile","refresh","_startCountDown","countDown","setInterval","_updateTitle","show","checkStatusTimeout","setTimeout","$el","find","text","clearInterval","initialize","back","remove","form"],"mappings":"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"}
{"version":3,"file":"VerifyDuoController.js","sources":["../../../../../src/v1/controllers/VerifyDuoController.js"],"sourcesContent":["/*!\n * Copyright (c) 2015-2016, Okta, Inc. and/or its affiliates. All rights reserved.\n * The Okta software accompanied by this notice is provided pursuant to the Apache License, Version 2.0 (the \"License.\")\n *\n * You may obtain a copy of the License at http://www.apache.org/licenses/LICENSE-2.0.\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n *\n * See the License for the specific language governing permissions and limitations under the License.\n */\n\n/* eslint camelcase: 0 */\nimport { $, _, loc } from 'okta';\nimport Duo from 'duo';\nimport Q from 'q';\nimport FactorUtil from 'util/FactorUtil';\nimport FormController from 'v1/util/FormController';\nimport FooterMFA from 'v1/views/shared/FooterMFA';\n\nexport default FormController.extend({\n  className: 'mfa-verify-duo duo-form',\n\n  Model: {\n    props: {\n      host: 'string',\n      signature: 'string',\n      postAction: 'string',\n      factorId: 'string',\n      stateToken: 'string',\n      rememberDevice: 'boolean',\n    },\n\n    initialize: function() {\n      const rememberDevice = FactorUtil.getRememberDeviceValue(this.appState);\n\n      // set the initial value for remember device (Cannot do this while defining the\n      // local property because this.settings would not be initialized there yet).\n      this.set('rememberDevice', rememberDevice);\n    },\n\n    getInitOptions: function() {\n      const rememberDevice = !!this.get('rememberDevice');\n\n      return this.doTransaction(function(transaction) {\n        const data = {\n          rememberDevice: rememberDevice,\n        };\n\n        const factor = _.findWhere(transaction.factors, {\n          provider: 'DUO',\n          factorType: 'web',\n        });\n\n        return factor.verify(data).catch(function(err) {\n          // Clean up the cookie on failure.\n          throw err;\n        });\n      }, true /* rethrow errors */);\n    },\n\n    verify: function(signedResponse) {\n      const url = this.get('postAction');\n      const factorId = this.get('factorId');\n      const self = this;\n      let data = {\n        id: factorId,\n        stateToken: this.get('stateToken'),\n        sig_response: signedResponse,\n      };\n      // Note: We should be doing this in OktaAuth! Fix when it's updated.\n\n      const rememberDevice = this.get('rememberDevice');\n      // We don't actually use authClient.post() here (unlike all the other cases in the\n      // sign-in widget) since the endpoint is wired to accept serialized form post instead\n      // of a JSON post ($.post() is different from authClient.post() in that in $.post(),\n      // jquery decides the Content-Type instead of it being a JSON type). Enroll/Verify DUO\n      // are the only two places where we actually do this.\n      // NOTE - If we ever decide to change this, we should test this very carefully.\n\n      return Q($.post(url, data))\n        .then(function() {\n          return self.doTransaction(function(transaction) {\n            let data;\n\n            if (rememberDevice) {\n              data = { rememberDevice: rememberDevice };\n            }\n            return transaction.poll(data);\n          });\n        })\n        .catch(function(err) {\n          self.trigger('error', self, err.xhr);\n        });\n    },\n  },\n\n  Form: {\n    autoSave: true,\n    noButtonBar: true,\n    title: _.partial(loc, 'factor.duo'),\n    attributes: { 'data-se': 'factor-duo' },\n\n    postRender: function() {\n      this.add('<iframe frameborder=\"0\" title=\"' + this.title() + '\"></iframe>');\n      if (this.options.appState.get('allowRememberDevice')) {\n        this.addInput({\n          label: false,\n          'label-top': true,\n          placeholder: this.options.appState.get('rememberDeviceLabel'),\n          className: 'margin-btm-0',\n          name: 'rememberDevice',\n          type: 'checkbox',\n        });\n      }\n      Duo.init({\n        host: this.model.get('host'),\n        sig_request: this.model.get('signature'),\n        iframe: this.$('iframe').get(0),\n        post_action: _.bind(this.model.verify, this.model),\n      });\n    },\n  },\n\n  fetchInitialData: function() {\n    const self = this;\n\n    return this.model.getInitOptions().then(function(trans) {\n      const res = trans.data;\n\n      if (\n        !res._embedded ||\n        !res._embedded.factor ||\n        !res._embedded.factor._embedded ||\n        !res._embedded.factor._embedded.verification\n      ) {\n        throw new Error('Response does not have duo verification options');\n      }\n      const verification = res._embedded.factor._embedded.verification;\n\n      self.model.set({\n        host: verification.host,\n        signature: verification.signature,\n        postAction: verification._links.complete.href,\n        factorId: res._embedded.factor.id,\n        stateToken: res.stateToken,\n      });\n    });\n  },\n\n  trapAuthResponse: function() {\n    if (this.options.appState.get('isMfaChallenge')) {\n      return true;\n    }\n  },\n\n  back: function() {\n    // Empty function on verify controllers to prevent users\n    // from navigating back during 'verify' using the browser's\n    // back button. The URL will still change, but the view will not\n    // More details in OKTA-135060.\n  },\n\n  Footer: FooterMFA,\n});\n"],"names":["FormController","extend","className","Model","props","host","signature","postAction","factorId","stateToken","rememberDevice","initialize","FactorUtil","getRememberDeviceValue","appState","set","getInitOptions","get","doTransaction","transaction","data","factor","_","findWhere","factors","provider","factorType","verify","catch","err","signedResponse","url","self","id","sig_response","Q","$","post","then","poll","trigger","xhr","Form","autoSave","noButtonBar","title","partial","loc","attributes","postRender","add","options","addInput","label","placeholder","name","type","Duo","init","model","sig_request","iframe","post_action","bind","fetchInitialData","trans","res","_embedded","verification","Error","_links","complete","href","trapAuthResponse","back","Footer","FooterMFA"],"mappings":"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"}
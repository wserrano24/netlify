{"version":3,"file":"PrimaryAuthController.js","sources":["../../../../../src/v1/controllers/PrimaryAuthController.js"],"sourcesContent":["/*!\n * Copyright (c) 2015-2016, Okta, Inc. and/or its affiliates. All rights reserved.\n * The Okta software accompanied by this notice is provided pursuant to the Apache License, Version 2.0 (the \"License.\")\n *\n * You may obtain a copy of the License at http://www.apache.org/licenses/LICENSE-2.0.\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n *\n * See the License for the specific language governing permissions and limitations under the License.\n */\n\nimport { $ } from 'okta';\nimport PrimaryAuthModel from 'v1/models/PrimaryAuth';\nimport BaseLoginController from 'v1/util/BaseLoginController';\nimport DeviceFingerprint from 'v1/util/DeviceFingerprint';\nimport CustomButtons from 'v1/views/primary-auth/CustomButtons';\nimport PrimaryAuthForm from 'v1/views/primary-auth/PrimaryAuthForm';\nimport Footer from 'v1/views/shared/Footer';\nimport FooterRegistration from 'v1/views/shared/FooterRegistration';\nimport FooterWithBackLink from 'v1/views/shared/FooterWithBackLink';\nexport default BaseLoginController.extend({\n  className: 'primary-auth',\n\n  state: { enabled: true },\n\n  View: PrimaryAuthForm,\n\n  constructor: function(options) {\n    options.appState.unset('username');\n\n    this.model = new PrimaryAuthModel(\n      {\n        multiOptionalFactorEnroll: options.settings.get('features.multiOptionalFactorEnroll'),\n        settings: options.settings,\n        appState: options.appState,\n      },\n      { parse: true }\n    );\n\n    BaseLoginController.apply(this, arguments);\n\n    this.addListeners();\n\n    // If social auth is configured, 'socialAuthPositionTop' will determine\n    // the order in which the social auth and primary auth are shown on the screen.\n    if (options.settings.get('hasConfiguredButtons')) {\n      this.add(CustomButtons, {\n        prepend: options.settings.get('socialAuthPositionTop'),\n        options: {\n          // To trigger an afterError event, we require the current controller\n          currentController: this,\n        },\n      });\n    }\n\n    this.addFooter(options);\n    if (this.options.appState.get('disableUsername')) {\n      this.addFooterWithBackLink(this.options);\n    }\n\n    this.setUsername();\n  },\n\n  addFooter: function(options) {\n    this.add(new Footer(this.toJSON({ appState: options.appState })));\n\n    if (options.settings.get('features.registration') || options.appState.get('isIdxStateToken')) {\n      this.add(\n        new FooterRegistration({\n          settings: this.settings,\n          appState: options.appState,\n        })\n      );\n    }\n  },\n\n  addFooterWithBackLink: function(options) {\n    if (!this.$el.find('.footer-back-link').length) {\n      this.add(new FooterWithBackLink(this.toJSON({ \n        appState: options.appState,\n        className: 'auth-footer footer-back-link',\n      })));\n    }\n  },\n\n  setUsername: function() {\n    const username = this.model.get('username');\n\n    if (username) {\n      this.options.appState.set('username', username);\n    }\n  },\n\n  events: {\n    'focusout input[name=username]': function() {\n      if (this.shouldComputeDeviceFingerprint() && this.model.get('username')) {\n        const self = this;\n\n        this.options.appState.trigger('loading', true);\n        DeviceFingerprint.generateDeviceFingerprint(this.settings.get('baseUrl'), this.$el)\n          .then(function(fingerprint) {\n            self.options.appState.set('deviceFingerprint', fingerprint);\n            self.options.appState.set('username', self.model.get('username'));\n          })\n          .catch(function() {\n            // Keep going even if device fingerprint fails\n            self.options.appState.set('username', self.model.get('username'));\n          })\n          .finally(function() {\n            self.options.appState.trigger('loading', false);\n          });\n      } else {\n        this.options.appState.set('username', this.model.get('username'));\n      }\n    },\n    'focusin input': function(e) {\n      $(e.target.parentElement).addClass('focused-input');\n    },\n    'focusout input': function(e) {\n      $(e.target.parentElement).removeClass('focused-input');\n    },\n  },\n\n  // This model and the AppState both have a username property.\n  // The controller updates the AppState's username when the user is\n  // done editing (on blur) or deletes the username (see below).\n  initialize: function() {\n    this.options.appState.unset('deviceFingerprint');\n    this.listenTo(this.model, 'change:username', function(model, value) {\n      if (!value) {\n        // reset AppState to an undefined user.\n        this.options.appState.set('username', '');\n      }\n    });\n    this.listenTo(this.model, 'save', function() {\n      this.state.set('enabled', false);\n    });\n    this.listenTo(this.model, 'error', function() {\n      this.state.set('enabled', true);\n      if (this.options.appState.get('disableUsername')) {\n        this.state.set('disableUsername', true);\n        this.addFooterWithBackLink(this.options);\n      }\n    });\n    this.listenTo(this.state, 'togglePrimaryAuthButton', function(buttonState) {\n      this.toggleButtonState(buttonState);\n    });\n  },\n\n  shouldComputeDeviceFingerprint: function() {\n    return (\n      this.settings.get('features.securityImage') &&\n      this.settings.get('features.deviceFingerprinting') &&\n      this.settings.get('features.useDeviceFingerprintForSecurityImage')\n    );\n  },\n});\n"],"names":["BaseLoginController","extend","className","state","enabled","View","PrimaryAuthForm","constructor","options","appState","unset","model","PrimaryAuthModel","multiOptionalFactorEnroll","settings","get","parse","apply","arguments","addListeners","add","CustomButtons","prepend","currentController","addFooter","addFooterWithBackLink","setUsername","Footer","toJSON","FooterRegistration","$el","find","length","FooterWithBackLink","username","set","events","shouldComputeDeviceFingerprint","self","trigger","DeviceFingerprint","generateDeviceFingerprint","then","fingerprint","catch","finally","e","$","target","parentElement","addClass","removeClass","initialize","listenTo","value","buttonState","toggleButtonState"],"mappings":"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"}
{"version":3,"file":"DeviceFingerprint.js","sources":["../../../../../src/v1/util/DeviceFingerprint.js"],"sourcesContent":["/*!\n * Copyright (c) 2015-2016, Okta, Inc. and/or its affiliates. All rights reserved.\n * The Okta software accompanied by this notice is provided pursuant to the Apache License, Version 2.0 (the \"License.\")\n *\n * You may obtain a copy of the License at http://www.apache.org/licenses/LICENSE-2.0.\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n *\n * See the License for the specific language governing permissions and limitations under the License.\n */\n\nimport { $ } from 'okta';\nimport Q from 'q';\nexport default {\n  getUserAgent: function() {\n    return navigator.userAgent;\n  },\n  isMessageFromCorrectSource: function($iframe, event) {\n    return event.source === $iframe[0].contentWindow;\n  },\n  generateDeviceFingerprint: function(oktaDomainUrl, element) {\n    const userAgent = this.getUserAgent();\n\n    if (!userAgent) {\n      return Q.reject('user agent is not defined');\n    } else if (isWindowsPhone(userAgent)) {\n      return Q.reject('device fingerprint is not supported on Windows phones');\n    }\n\n    const deferred = Q.defer();\n    const self = this;\n    let $iframe;\n    let iFrameTimeout;\n\n    function isWindowsPhone(userAgent) {\n      return userAgent.match(/windows phone|iemobile|wpdesktop/i);\n    }\n\n    function removeIframe() {\n      $iframe.off();\n      $iframe.remove();\n      window.removeEventListener('message', onMessageReceivedFromOkta, false);\n    }\n\n    function handleError(reason) {\n      removeIframe();\n      deferred.reject(reason);\n    }\n\n    function onMessageReceivedFromOkta(event) {\n      if (!self.isMessageFromCorrectSource($iframe, event)) {\n        return;\n      }\n      // deviceFingerprint service is available, clear timeout\n      clearTimeout(iFrameTimeout);\n      if (!event || !event.data || event.origin !== oktaDomainUrl) {\n        handleError('no data');\n        return;\n      }\n      try {\n        const message = JSON.parse(event.data);\n\n        if (message && message.type === 'FingerprintServiceReady') {\n          sendMessageToOkta({ type: 'GetFingerprint' });\n        } else if (message && message.type === 'FingerprintAvailable') {\n          removeIframe();\n          deferred.resolve(message.fingerprint);\n        } else {\n          handleError('no data');\n        }\n      } catch (error) {\n        //Ignore any errors since we could get other messages too\n      }\n    }\n\n    function sendMessageToOkta(message) {\n      const win = $iframe[0].contentWindow;\n\n      if (win) {\n        win.postMessage(JSON.stringify(message), oktaDomainUrl);\n      }\n    }\n\n    // Attach listener\n    window.addEventListener('message', onMessageReceivedFromOkta, false);\n    // Create and Load devicefingerprint page inside the iframe\n    $iframe = $('<iframe>', {\n      style: 'display: none;',\n      src: oktaDomainUrl + '/auth/services/devicefingerprint',\n    });\n    element.append($iframe);\n\n    iFrameTimeout = setTimeout(() => {\n      // If the iFrame does not load, throw an error\n      handleError('service not available');\n    }, 2000);\n\n    return deferred.promise;\n  },\n};\n"],"names":["getUserAgent","navigator","userAgent","isMessageFromCorrectSource","$iframe","event","source","contentWindow","generateDeviceFingerprint","oktaDomainUrl","element","Q","reject","isWindowsPhone","deferred","defer","self","iFrameTimeout","match","removeIframe","off","remove","window","removeEventListener","onMessageReceivedFromOkta","handleError","reason","clearTimeout","data","origin","message","JSON","parse","type","sendMessageToOkta","resolve","fingerprint","error","win","postMessage","stringify","addEventListener","$","style","src","append","setTimeout","promise"],"mappings":"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"}
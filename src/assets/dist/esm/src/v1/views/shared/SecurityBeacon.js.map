{"version":3,"file":"SecurityBeacon.js","sources":["../../../../../../src/v1/views/shared/SecurityBeacon.js"],"sourcesContent":["/*!\n * Copyright (c) 2015-2016, Okta, Inc. and/or its affiliates. All rights reserved.\n * The Okta software accompanied by this notice is provided pursuant to the Apache License, Version 2.0 (the \"License.\")\n *\n * You may obtain a copy of the License at http://www.apache.org/licenses/LICENSE-2.0.\n * Unless required by applicable law or agreed to in writing, software\n * distributed under the License is distributed on an \"AS IS\" BASIS, WITHOUT\n * WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\n *\n * See the License for the specific language governing permissions and limitations under the License.\n */\n\nimport { _, $, loc, View } from 'okta';\nimport hbs from 'handlebars-inline-precompile';\nimport Animations from 'util/Animations';\n\nfunction setBackgroundImage(el, appState) {\n  const imgSrc = appState.get('securityImage');\n  const imgDescription = appState.get('securityImageDescription');\n  const isUndefinedUser = appState.get('isUndefinedUser');\n  const isNewUser = appState.get('isNewUser');\n  const isSecurityImage = !isUndefinedUser && !isNewUser;\n  // NOTE: The imgSrc is returned by the server so that every\n  // user has a unique image. However new and undefined user states\n  // are hard coded into the css and the value returned by the server\n  // is ignored.\n\n  el.css('background-image', '');\n  el.removeClass('new-user undefined-user');\n  if (isNewUser) {\n    el.addClass('new-user');\n    return;\n  }\n  if (isUndefinedUser) {\n    el.addClass('undefined-user');\n    return;\n  }\n  if (isSecurityImage) {\n    // TODO: Newer versions of qtip will remove aria-describedby on their own when destroy() is called.\n    el.removeAttr('aria-describedby');\n    el.find('.accessibility-text').text(imgDescription);\n    el.css('background-image', 'url(' + _.escape(imgSrc) + ')');\n    return;\n  }\n}\n\nfunction antiPhishingMessage(image, host) {\n  $(window).on(\n    'resize.securityBeaconQtip',\n    _.debounce(function() {\n      if (image.is(':visible')) {\n        image.qtip('show');\n      }\n    }, 300)\n  );\n\n  // Show the message that the user has not logged in from this device before.\n  image.qtip({\n    prerender: true,\n    content: {\n      text: loc('primaryauth.newUser.tooltip', 'login', [_.escape(host)]),\n      button: loc('primaryauth.newUser.tooltip.close', 'login'),\n    },\n    style: {\n      classes: 'okta-security-image-tooltip security-image-qtip qtip-custom qtip-shadow qtip-rounded',\n      tip: { height: 12, width: 16 },\n    },\n    position: {\n      my: 'top center',\n      at: 'center',\n      target: $('.auth-beacon-security'),\n      adjust: { method: 'flip', scroll: false, resize: true },\n      effect: false,\n    },\n    hide: { event: false, fixed: true },\n    show: { event: false, delay: 200 },\n    events: {\n      move: function(event, api) {\n        if (!api.elements.target.is(':visible')) {\n          // Have to hide it immediately, with no effect\n          api.set('hide.effect', false);\n          api.hide();\n          api.set('hide.effect', true);\n        }\n      },\n    },\n  });\n\n  // It is necessary to delay toggle to the next render cycle, since qtip internally defers some setup tasks.\n  setTimeout(() => {\n    image.qtip('toggle', image.is(':visible'));\n  }, 0);\n}\n\nfunction destroyAntiPhishingMessage(image) {\n  image.qtip('destroy');\n  $(window).off('resize.securityBeaconQtip');\n}\n\nasync function updateSecurityImage($el, appState, animate) {\n  const image = $el.find('.auth-beacon-security');\n  const border = $el.find('.js-auth-beacon-border');\n  const hasBorder = !appState.get('isUndefinedUser');\n  const hasAntiPhishing = appState.get('isNewUser');\n  const radialProgressBar = $el.find('.radial-progress-bar');\n  const host = appState.get('baseUrl').match(/https?:\\/\\/(.[^/]+)/)[1];\n  const duration = 200;\n\n  if (!animate) {\n    // Do not animate the security beacon\n    // This occurs when initializing the form\n    setBackgroundImage(image, appState);\n    border.toggleClass('auth-beacon-border', hasBorder);\n    return;\n  }\n\n  destroyAntiPhishingMessage(image);\n\n  // Animate loading the security beacon\n  if (!hasBorder) {\n    // This occurs when appState username is blank\n    // we do not yet know if the user is recognized\n    image.fadeOut(duration, function() {\n      setBackgroundImage(image, appState);\n      border.removeClass('auth-beacon-border');\n      image.fadeIn(duration);\n    });\n  } else {\n    // Animate loading the security beacon with a loading bar for the border\n    // This occurs when the username has been checked against Okta.\n    border.removeClass('auth-beacon-border');\n    await Animations.radialProgressBar({\n      $el: radialProgressBar,\n      swap() {\n        image.fadeOut(duration, () => {\n          setBackgroundImage(image, appState);\n          image.fadeIn(duration);\n        });\n      },\n    });\n    border.addClass('auth-beacon-border');\n    if (hasAntiPhishing) {\n      antiPhishingMessage(image, host);\n    }\n  }\n}\n\nexport default View.extend({\n  template: hbs(\n    '\\\n    <div class=\"beacon-blank\">\\\n      <div class=\"radial-progress-bar\">\\\n        <div class=\"circle left\"></div>\\\n        <div class=\"circle right\"></div>\\\n      </div>\\\n    </div>\\\n    <div aria-live=\"polite\" role=\"img\" class=\"bg-helper auth-beacon auth-beacon-security\" data-se=\"security-beacon\">\\\n      <span class=\"accessibility-text\"></span>\\\n      <div class=\"okta-sign-in-beacon-border auth-beacon-border js-auth-beacon-border\">\\\n      </div>\\\n    </div>\\\n    '\n  ),\n  className: 'js-security-beacon',\n\n  initialize: function(options) {\n    this.update = _.partial(updateSecurityImage, this.$el, options.appState);\n    this.listenTo(options.appState, 'change:securityImage', this.update);\n    this.listenTo(options.appState, 'loading', function(isLoading) {\n      this.$el.toggleClass('beacon-loading', isLoading);\n      this.removeAntiPhishingMessage();\n    });\n    this.options.appState.set('beaconType', 'security');\n\n    this.listenTo(options.appState, 'navigate', this.removeAntiPhishingMessage);\n  },\n\n  postRender: function() {\n    this.update(false);\n  },\n\n  equals: function(Beacon) {\n    return Beacon && this instanceof Beacon;\n  },\n\n  removeAntiPhishingMessage: function() {\n    const image = this.$el.find('.auth-beacon-security');\n\n    image.qtip('destroy');\n  },\n});\n"],"names":["setBackgroundImage","el","appState","imgSrc","get","imgDescription","isUndefinedUser","isNewUser","isSecurityImage","css","removeClass","addClass","removeAttr","find","text","_","escape","antiPhishingMessage","image","host","$","window","on","debounce","is","qtip","prerender","content","loc","button","style","classes","tip","height","width","position","my","at","target","adjust","method","scroll","resize","effect","hide","event","fixed","show","delay","events","move","api","elements","set","setTimeout","destroyAntiPhishingMessage","off","updateSecurityImage","$el","animate","border","hasBorder","hasAntiPhishing","radialProgressBar","match","duration","toggleClass","fadeOut","fadeIn","Animations","swap","View","extend","template","className","initialize","options","update","partial","listenTo","isLoading","removeAntiPhishingMessage","postRender","equals","Beacon"],"mappings":"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"}